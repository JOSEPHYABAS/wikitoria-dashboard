<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wikitoria Dashboard — Gestion Comptable Complète</title>

<!-- Firebase SDK v9 (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  :root{
    --bg:#f7f8fb;
    --panel:#ffffff;
    --line:#e7e9f0;
    --muted:#5a647a;
    --text:#0e1320;
    --brand:#2b5cff;
    --ok:#14b37d;
    --ko:#e24d4d;
    --na:#a7b0c2;
    --warning:#f59e0b;
    --purple:#8b5cf6;
    --cyan:#06b6d4;
    --pink:#ec4899;
    --radius:14px;
    --shadow: 0 8px 24px rgba(15,31,60,0.06);
  }
  *{ box-sizing:border-box; }
  html, body{ height:100%; margin:0; }
  body{
    background:var(--bg); color:var(--text);
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  
  /* Topbar & Tabs */
  .topbar{ 
    position:sticky; top:0; z-index:20; 
    background:var(--bg); 
    padding: 14px 20px 0; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .tabs{ display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid var(--line); }
  .tab{
    appearance:none; border:0; background:transparent; cursor:pointer;
    padding:12px 16px; border-top-left-radius:10px; border-top-right-radius:10px;
    color:var(--muted); font-weight:600; position:relative; transition: all 0.2s;
    font-size: 14px;
  }
  .tab:hover{ background: rgba(43, 92, 255, 0.05); }
  .tab.active{ color:var(--text); }
  .tab.active::after{
    content:""; position:absolute; left:0; right:0; bottom:-1px; height:3px;
    background:var(--brand); border-radius:3px 3px 0 0;
  }
  
  /* Sub-tabs pour Admin */
  .sub-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--line);
    padding-bottom: 8px;
  }
  .sub-tab {
    appearance: none;
    border: 0;
    background: transparent;
    cursor: pointer;
    padding: 8px 16px;
    border-radius: 8px;
    color: var(--muted);
    font-weight: 600;
    font-size: 13px;
    transition: all 0.2s;
  }
  .sub-tab:hover {
    background: rgba(43, 92, 255, 0.05);
  }
  .sub-tab.active {
    background: var(--brand);
    color: white;
  }
  
  /* User bar */
  .userbar{ 
    display:flex; gap:10px; align-items:center; 
    padding:8px 0 12px; justify-content: space-between;
  }
  .pill{ 
    padding:6px 12px; border-radius:999px; 
    border:1px solid var(--line); background:#fff; 
    font-size:12px; font-weight:500;
  }
  
  /* Main content */
  .wrap{ padding: 0 20px 20px; max-width: 1600px; margin: 0 auto; }
  .panel{
    background:var(--panel); border:1px solid var(--line);
    border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px;
  }
  
  /* Toolbar */
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
  .toolbar .search{
    display:flex; align-items:center; gap:10px; border:1px solid var(--line); background:#fff;
    border-radius:12px; padding:10px 12px; flex:1 1 260px;
  }
  .toolbar input, .toolbar select{ 
    border:0; outline:0; background:transparent; 
    width:100%; color:var(--text); font-size:14px;
  }
  
  /* Buttons */
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:var(--text); border-radius:12px;
    padding:10px 14px; font-weight:600; cursor:pointer; transition: all 0.2s; font-size:14px;
  }
  .btn:hover{ background: #f8f9fb; transform: translateY(-1px); }
  .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff; }
  .btn.primary:hover{ background: #1e4fd9; }
  .btn.small{ padding:6px 10px; border-radius:8px; font-size:12px; }
  .btn.danger{ background:#e24d4d; border-color:#e24d4d; color:#fff; }
  .btn.success{ background:var(--ok); border-color:var(--ok); color:#fff; }
  .btn.warning{ background:var(--warning); border-color:var(--warning); color:#fff; }
  
  /* Tables */
  table{ width:100%; border-collapse: collapse; }
  th, td{ padding:12px 10px; text-align:left; border-bottom:1px solid var(--line); font-size:14px;}
  th{ color:#2b3552; font-weight:700; background: #fafbff; position:sticky; top:0; z-index:1; }
  tbody tr{ transition: all 0.2s; }
  tbody tr:hover{ background:#fafcff; cursor: pointer; }
  
  /* Badges & Status */
  .badge{ 
    display:inline-flex; align-items:center; gap:6px; padding:6px 10px; 
    border-radius:999px; border:1px solid var(--line); background:#fff; font-size:12px; font-weight:500;
  }
  .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; }
  .ok{ background: var(--ok); } 
  .ko{ background: var(--ko);} 
  .na{ background: var(--na);}
  
  /* Pictos TEXTE colorés */
  .picto-cell {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
  }
  .picto-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    border: 1px solid;
  }
  .picto-cfe {
    background: #fef3c7;
    color: #92400e;
    border-color: #fcd34d;
  }
  .picto-tvs {
    background: #fce7f3;
    color: #9f1239;
    border-color: #f9a8d4;
  }
  .picto-irpp {
    background: #e0e7ff;
    color: #4338ca;
    border-color: #a5b4fc;
  }
  .picto-revision {
    background: #d1fae5;
    color: #065f46;
    border-color: #6ee7b7;
  }
  .picto-revision.en-cours {
    background: #dbeafe;
    color: #1e40af;
    border-color: #93c5fd;
  }
  .picto-revision.non-commence {
    background: #f3f4f6;
    color: #4b5563;
    border-color: #d1d5db;
  }
  
  /* Status badges pour TVA */
  .status-badge {
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
    border: 1px solid;
  }
  .status-relance { 
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
    color: #92400e; 
    border-color: #fcd34d;
  }
  .status-attente { 
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); 
    color: #1e40af; 
    border-color: #93c5fd;
  }
  .status-saisie { 
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); 
    color: #4338ca; 
    border-color: #a5b4fc;
  }
  .status-controle { 
    background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); 
    color: #9f1239; 
    border-color: #f9a8d4;
  }
  .status-edi { 
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
    color: #065f46; 
    border-color: #6ee7b7;
  }
  .status-ok { 
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
    color: #065f46; 
    border-color: #6ee7b7;
  }
  
  /* Modal */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); z-index: 100;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.2s;
  }
  .modal-content {
    background: white; border-radius: 20px;
    max-width: 1000px; width: 90%; max-height: 90vh;
    overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s;
  }
  .modal-header {
    padding: 24px; border-bottom: 1px solid var(--line);
    display: flex; justify-content: space-between; align-items: center;
  }
  .modal-body { padding: 24px; }
  .modal-footer {
    padding: 20px 24px; border-top: 1px solid var(--line);
    display: flex; gap: 10px; justify-content: flex-end;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  /* Forms */
  .form-group { margin-bottom: 16px; }
  .form-label { 
    display: block; font-weight: 600; 
    margin-bottom: 6px; font-size: 13px; color: var(--text);
  }
  .form-control {
    width: 100%; padding: 10px 12px;
    border: 1px solid var(--line); border-radius: 10px;
    font-size: 14px; transition: all 0.2s;
  }
  .form-control:focus {
    outline: none; border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(43, 92, 255, 0.1);
  }
  
  /* Sections colorées dans le modal */
  .section-box {
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 2px solid;
  }
  .section-box.tva-box {
    background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
    border-color: #93c5fd;
  }
  .section-box.cfe-box {
    background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
    border-color: #fcd34d;
  }
  .section-box.tvs-box {
    background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%);
    border-color: #f9a8d4;
  }
  .section-box.irpp-box {
    background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%);
    border-color: #a5b4fc;
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Checkboxes */
  .checkbox-group {
    display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;
  }
  .checkbox-label {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px; border: 1px solid var(--line);
    border-radius: 10px; cursor: pointer; transition: all 0.2s;
    background: white;
  }
  .checkbox-label:hover {
    border-color: var(--brand); background: rgba(43, 92, 255, 0.03);
  }
  .checkbox-label input[type="checkbox"] {
    width: 18px; height: 18px; cursor: pointer;
  }
  .checkbox-label.checked {
    border-color: var(--brand); background: rgba(43, 92, 255, 0.08);
  }
  
  /* Radio buttons */
  .radio-group {
    display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;
  }
  .radio-label {
    display: flex; align-items: center; gap: 6px;
    padding: 8px 12px; border: 1px solid var(--line);
    border-radius: 10px; cursor: pointer; transition: all 0.2s;
    background: white; font-size: 13px;
  }
  .radio-label:hover {
    border-color: var(--brand); background: rgba(43, 92, 255, 0.03);
  }
  .radio-label input[type="radio"] {
    width: 16px; height: 16px; cursor: pointer;
  }
  .radio-label.checked {
    border-color: var(--brand); background: rgba(43, 92, 255, 0.08);
    font-weight: 600;
  }
  
  /* Notification toast */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    max-width: 400px;
  }
  .toast.success {
    border-left: 4px solid var(--ok);
  }
  .toast.error {
    border-left: 4px solid var(--ko);
  }
  .toast.info {
    border-left: 4px solid var(--brand);
  }
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  /* Grid layout */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
  
  /* Calendar styles */
  .calendar-layout {
    display: flex;
    gap: 20px;
  }
  .calendar-sidebar {
    flex: 0 0 80px;
  }
  .calendar-main {
    flex: 1;
    display: flex;
    gap: 16px;
  }
  .calendar-hours {
    display: flex;
    flex-direction: column;
    border-right: 2px solid var(--line);
    padding-right: 12px;
  }
  .calendar-hour {
    height: 60px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    border-bottom: 1px solid var(--line);
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }
  .calendar-grid-week {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    flex: 1;
  }
  .calendar-day-col {
    border: 1px solid var(--line);
    border-radius: 10px;
    overflow: hidden;
    background: white;
  }
  .calendar-day-header {
    padding: 12px;
    background: #fafbff;
    border-bottom: 1px solid var(--line);
    font-weight: 700;
    font-size: 13px;
    text-align: center;
  }
  .calendar-time-slots {
    position: relative;
    height: 780px;
  }
  .calendar-event-block {
    position: absolute;
    left: 4px;
    right: 4px;
    padding: 6px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
  }
  .calendar-event-block:hover {
    transform: scale(1.02);
    z-index: 10;
  }
  .calendar-event-block.tva { background: #dbeafe; color: #1e40af; border: 2px solid #93c5fd; }
  .calendar-event-block.cfe { background: #fef3c7; color: #92400e; border: 2px solid #fcd34d; }
  .calendar-event-block.tvs { background: #fce7f3; color: #9f1239; border: 2px solid #f9a8d4; }
  .calendar-event-block.rdv { background: #e0e7ff; color: #4338ca; border: 2px solid #a5b4fc; }
  .calendar-event-block.alerte { background: #fee2e2; color: #991b1b; border: 2px solid #fca5a5; }

  /* ==================== LOGIN PAGE STYLES ==================== */
  .login-container {
    display: flex !important;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 9999;
  }
  
  .login-box {
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 400px;
  }
  
  .login-logo {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .login-logo h1 {
    color: #2563eb;
    font-size: 28px;
    margin-bottom: 8px;
  }
  
  .login-logo p {
    color: #64748b;
    font-size: 14px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #334155;
  }
  
  .form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.3s;
  }
  
  .form-group input:focus {
    outline: none;
    border-color: #2563eb;
  }
  
  .btn-login {
    width: 100%;
    padding: 14px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .btn-login:hover {
    background: #1e40af;
  }
  
  .btn-login:disabled {
    background: #64748b;
    cursor: not-allowed;
  }
  
  .forgot-password {
    text-align: center;
    margin-top: 16px;
  }
  
  .forgot-password a {
    color: #2563eb;
    text-decoration: none;
    font-size: 14px;
  }
  
  .auth-message {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
  }
  
  .auth-error {
    background: #fee;
    color: #ef4444;
    border: 1px solid #ef4444;
  }
  
  .auth-success {
    background: #efe;
    color: #10b981;
    border: 1px solid #10b981;
  }
  
  .hidden {
    display: none !important;
  }
  
  /* User bar pour logout */
  .logout-bar {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    padding: 8px 16px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: none;
  }
  
  .logout-bar.visible {
    display: flex !important;
    align-items: center;
    gap: 12px;
  }
  
  .user-info-compact {
    font-size: 13px;
    color: #334155;
    font-weight: 500;
  }
  
  .btn-logout {
    padding: 6px 12px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.3s;
  }
  
  .btn-logout:hover {
    background: #dc2626;
  }
</style>
</head>
<body>
  <!-- Login Page -->
  <div id="login-page" class="login-container">
    <div class="login-box">
      <div class="login-logo">
        <h1>🏢 Wikitoria Dashboard</h1>
        <p>Gestion Comptable Multi-Agences</p>
      </div>
      
      <div id="auth-error" class="auth-message auth-error"></div>
      <div id="auth-success" class="auth-message auth-success"></div>
      
      <form id="login-form">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" placeholder="votre@email.fr" required>
        </div>
        <div class="form-group">
          <label>Mot de passe</label>
          <input type="password" id="password" placeholder="••••••••" required>
        </div>
        <button type="submit" id="login-btn" class="btn-login">Se connecter</button>
      </form>
      
      <div class="forgot-password">
        <a href="#" id="forgot-password">Mot de passe oublié ?</a>
      </div>
    </div>
  </div>

  <!-- Logout Bar -->
  <div id="logout-bar" class="logout-bar">
    <span class="user-info-compact" id="user-email">user@example.com</span>
    <button id="logout-btn" class="btn-logout">Déconnexion</button>
  </div>

  <!-- Dashboard Content -->
  <div id="root" class="hidden"></div>
  
  <script>
  // ==================== FIREBASE CONFIG & AUTH ====================
  const firebaseConfig = {
    apiKey: "AIzaSyA8a89MzLBbRcQpLeqadzUJENwS_XwIWzY",
    authDomain: "wikitoria-dashboard.firebaseapp.com",
    databaseURL: "https://wikitoria-dashboard-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "wikitoria-dashboard",
    storageBucket: "wikitoria-dashboard.firebasestorage.app",
    messagingSenderId: "841128545223",
    appId: "1:841128545223:web:4086ebc079a478e86067e2",
    measurementId: "G-FVGVTE0P27"
  };

  let auth, database;
  let currentUser = null;

  // Initialize Firebase
  try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    database = firebase.database();
    console.log('✅ Firebase initialisé avec succès');
  } catch (error) {
    console.error('❌ Erreur initialisation Firebase:', error);
  }

  // Auth state observer
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      showDashboard();
    } else {
      currentUser = null;
      showLoginPage();
    }
  });

  // Login form handler
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessages();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const loginBtn = document.getElementById('login-btn');
      
      loginBtn.disabled = true;
      loginBtn.innerHTML = 'Connexion...';
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        let msg = "Erreur de connexion.";
        if (error.code === 'auth/user-not-found') msg = "Utilisateur non trouvé.";
        else if (error.code === 'auth/wrong-password') msg = "Mot de passe incorrect.";
        else if (error.code === 'auth/invalid-email') msg = "Email invalide.";
        else if (error.code === 'auth/invalid-credential') msg = "Email ou mot de passe incorrect.";
        showError(msg);
        loginBtn.disabled = false;
        loginBtn.innerHTML = 'Se connecter';
      }
    });

    // Logout button handler
    document.getElementById('logout-btn').addEventListener('click', () => {
      if (confirm('Voulez-vous vraiment vous déconnecter ?')) {
        auth.signOut();
      }
    });

    // Forgot password handler
    document.getElementById('forgot-password').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      if (!email) { 
        showError("Entrez votre email d'abord."); 
        return; 
      }
      try {
        await auth.sendPasswordResetEmail(email);
        showSuccess("Email de réinitialisation envoyé !");
      } catch (error) {
        showError("Erreur d'envoi.");
      }
    });
  });

  function showLoginPage() {
    document.getElementById('login-page').classList.remove('hidden');
    document.getElementById('logout-bar').classList.remove('visible');
    document.getElementById('root').classList.add('hidden');
  }

  function showDashboard() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('logout-bar').classList.add('visible');
    document.getElementById('root').classList.remove('hidden');
    
    const userEmail = document.getElementById('user-email');
    userEmail.textContent = currentUser.email;
    
    // Initialiser le dashboard React après authentification
    if (typeof initDashboardApp === 'function') {
      initDashboardApp();
    }
  }

  function showError(msg) {
    const div = document.getElementById('auth-error');
    div.textContent = msg;
    div.style.display = 'block';
  }

  function showSuccess(msg) {
    const div = document.getElementById('auth-success');
    div.textContent = msg;
    div.style.display = 'block';
  }

  function hideMessages() {
    document.getElementById('auth-error').style.display = 'none';
    document.getElementById('auth-success').style.display = 'none';
  }
  </script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    
    // ==================== DATA INITIAL ====================
    // Toutes les agences du fichier Excel
    const AGENCIES = [
      { id: 'bleue', name: 'Bleue', color: '#2b5cff' },
      { id: 'noailles', name: 'Noailles', color: '#14b37d' },
      { id: 'therese', name: 'Thérèse', color: '#8b5cf6' },
      { id: 'villiers-le-bel', name: 'Villiers-le-Bel', color: '#f59e0b' },
      { id: 'creil', name: 'Creil', color: '#06b6d4' },
      { id: 'tous', name: 'Tous', color: '#ec4899' }
    ];
    
    // Tous les utilisateurs du fichier Excel (46 utilisateurs)
    const ALL_USERS = [
      { id: 1, email: 'joseph@fiscality.fr', prenom: 'Joseph', nom: 'YABAS', role: 'Admin', agences: ['tous'] },
      { id: 2, email: 'patrice@fiscality.fr', prenom: 'Patrice', nom: 'DUMAN', role: 'Admin', agences: ['tous'] },
      { id: 3, email: 'domingos@fiscality75.fr', prenom: 'Domingos', nom: 'RODRIGUES', role: 'Chef d\'agence', agences: ['bleue'] },
      { id: 4, email: 'maxence@fiscality60.fr', prenom: 'Maxence', nom: 'ROUSSEL', role: 'Chef d\'agence', agences: ['noailles'] },
      { id: 5, email: 'romain@fiscality75.fr', prenom: 'Romain', nom: 'LOIR', role: 'Chef d\'agence', agences: ['therese'] },
      { id: 6, email: 'u.unsal@fiscality60.fr', prenom: 'Umut', nom: 'UNSAL', role: 'Chef d\'agence', agences: ['creil'] },
      { id: 7, email: 'ismael@fiscality75.fr', prenom: 'Ismael', nom: 'BENABDESADOK', role: 'Comptable', agences: ['bleue'] },
      { id: 8, email: 'marine@fiscality75.fr', prenom: 'Marine', nom: 'RODRIGUES', role: 'Comptable', agences: ['bleue'] },
      { id: 9, email: 'ozge@fiscality75.fr', prenom: 'Ozge', nom: 'MAZELLA DI BOSCO', role: 'Comptable', agences: ['bleue'] },
      { id: 10, email: 'raziye@fiscality75.fr', prenom: 'Raziye', nom: 'ELDENIZ', role: 'Comptable', agences: ['bleue'] },
      { id: 11, email: 'baptiste@fiscality60.fr', prenom: 'Baptiste', nom: 'DUMONT', role: 'Comptable', agences: ['noailles'] },
      { id: 12, email: 'contact@fiscality60.fr', prenom: 'FISCALITY 60', nom: 'Expert-Comptable', role: 'Comptable', agences: ['noailles'] },
      { id: 13, email: 'corinne@fiscality60.fr', prenom: 'Corinne', nom: 'BEAUVAIS', role: 'Comptable', agences: ['noailles'] },
      { id: 14, email: 'estelle@fiscality60.fr', prenom: 'Estelle', nom: 'DUPRE', role: 'Comptable', agences: ['noailles'] },
      { id: 15, email: 'helene@fiscality60.fr', prenom: 'Hélène', nom: 'LEDARD', role: 'Comptable', agences: ['noailles'] },
      { id: 16, email: 'sandrine@fiscality60.fr', prenom: 'Sandrine', nom: 'BAUDENAILLE', role: 'Comptable', agences: ['noailles'] },
      { id: 17, email: 'yann@fiscality60.fr', prenom: 'Yann', nom: 'GARNIER', role: 'Comptable', agences: ['noailles'] },
      { id: 18, email: 'didier@fiscality75.fr', prenom: 'Didier', nom: 'CHAMBARD', role: 'Comptable', agences: ['therese'] },
      { id: 19, email: 'amelie@fiscality75.fr', prenom: 'Amélie', nom: 'QUINTON', role: 'Comptable', agences: ['therese'] },
      { id: 20, email: 'anna-maria@fiscality75.fr', prenom: 'Anna-Maria', nom: 'USHKOVSKI', role: 'Comptable', agences: ['therese'] },
      { id: 21, email: 'anne@fiscality75.fr', prenom: 'Anne', nom: 'HERVE', role: 'Comptable', agences: ['therese'] },
      { id: 22, email: 'asmaa@fiscality75.fr', prenom: 'Asmaa', nom: 'EL BEYALY', role: 'Comptable', agences: ['therese'] },
      { id: 23, email: 'info@fiscality75.fr', prenom: 'Iris', nom: 'EM', role: 'Comptable', agences: ['therese'] },
      { id: 24, email: 'jean-louis@fiscality75.fr', prenom: 'Jean-Louis', nom: 'MONGIN', role: 'Comptable', agences: ['therese'] },
      { id: 25, email: 'lilou@fiscality75.fr', prenom: 'Lilou', nom: 'ROULAND', role: 'Comptable', agences: ['therese'] },
      { id: 26, email: 'marie-claire@fiscality75.fr', prenom: 'Marie-Claire', nom: 'DRONVAL', role: 'Comptable', agences: ['therese'] },
      { id: 27, email: 'noah@fiscality75.fr', prenom: 'Noah', nom: 'CORFMAT', role: 'Comptable', agences: ['therese'] },
      { id: 28, email: 'regina@fiscality75.fr', prenom: 'Regina', nom: 'JOVANOVIC', role: 'Comptable', agences: ['therese'] },
      { id: 29, email: 'carine@fiscality.fr', prenom: 'Carine', nom: 'YALAP', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 30, email: 'corine@fiscality.fr', prenom: 'Corine', nom: 'DOS SANTOS BARREIRA', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 31, email: 'derya@fiscality.fr', prenom: 'Derya', nom: 'SERT', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 32, email: 'compta95@fiscality.fr', prenom: 'compta95', nom: 'FISCALITY', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 33, email: 'paye@fiscality.fr', prenom: 'Fiscality', nom: 'Paye', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 34, email: 'najlaa@fiscality.fr', prenom: 'Najlaa', nom: 'ZIAR', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 35, email: 'ozlem@fiscality.fr', prenom: 'Ozlem', nom: 'GENC', role: 'Comptable', agences: ['villiers-le-bel'] },
      { id: 36, email: 'ekin@fiscality60.fr', prenom: 'Ekin', nom: 'CEYLAN', role: 'Comptable', agences: ['creil'] },
      { id: 37, email: 'maryam@fiscality60.fr', prenom: 'Maryam', nom: 'KESKAS', role: 'Comptable', agences: ['creil'] },
      { id: 38, email: 'elif@fiscality60.fr', prenom: 'Elif', nom: 'KOLANKAYA', role: 'Comptable', agences: ['creil'] },
      { id: 39, email: 'abi@fiscality60.fr', prenom: 'Abi', nom: 'MBENGUE', role: 'Comptable', agences: ['creil'] },
      { id: 40, email: 'achouak@fiscality60.fr', prenom: 'Achouak', nom: 'AYEB', role: 'Comptable', agences: ['creil'] },
      { id: 41, email: 'brahim@fiscality60.fr', prenom: 'Brahim', nom: 'LOUKILI', role: 'Comptable', agences: ['creil'] },
      { id: 42, email: 'hava@fiscality60.fr', prenom: 'Hava', nom: 'ATAKAYA', role: 'Comptable', agences: ['creil'] },
      { id: 43, email: 'compta1@fiscality.fr', prenom: 'Fatima El Zahra', nom: 'JOUALI', role: 'Comptable', agences: ['tous'] },
      { id: 44, email: 'paye1@fiscality.fr', prenom: 'Hasnaa', nom: 'YAKKAM', role: 'Comptable', agences: ['tous'] },
      { id: 45, email: 'juridique@fiscality.fr', prenom: 'Juridique', nom: 'FISCALITY', role: 'Comptable', agences: ['tous'] },
      { id: 46, email: 'compta1@proratio.fr', prenom: 'Meryem', nom: 'AZIM', role: 'Comptable', agences: ['tous'] }
    ];
    
    // Calcul TVS 2025
    const TVS_2025_BAREME = {
      co2: [
        { max: 0, tarif: 0 },
        { max: 20, tarif: 1 },
        { max: 40, tarif: 2 },
        { max: 60, tarif: 3 },
        { max: 100, tarif: 4.5 },
        { max: 120, tarif: 6.5 },
        { max: 140, tarif: 13 },
        { max: 160, tarif: 19.5 },
        { max: 200, tarif: 23.5 },
        { max: 250, tarif: 29 },
        { max: Infinity, tarif: 34 }
      ],
      air: [
        { max: 0, tarif: 0 },
        { max: 60, tarif: 1 },
        { max: 100, tarif: 2 },
        { max: 120, tarif: 3.5 },
        { max: 140, tarif: 7 },
        { max: 160, tarif: 10.5 },
        { max: 200, tarif: 16 },
        { max: 250, tarif: 20 },
        { max: Infinity, tarif: 24 }
      ],
      electrique: [
        { max: 0, tarif: 0 },
        { max: 20, tarif: 0.5 },
        { max: 45, tarif: 1 },
        { max: 60, tarif: 1.5 },
        { max: Infinity, tarif: 2 }
      ]
    };
    
    function calculateTVS2025(vehicule) {
      const { type, puissance, co2, anneeCirculation, dateAchat, dateVente } = vehicule;
      let tarifUnitaire = 0;
      
      if (type === 'electrique' || type === 'hydrogene') {
        const conso = co2 || 0;
        for (let tranche of TVS_2025_BAREME.electrique) {
          if (conso <= tranche.max) {
            tarifUnitaire = tranche.tarif;
            break;
          }
        }
      } else {
        const ancienVehicule = anneeCirculation && anneeCirculation < 2020;
        const bareme = ancienVehicule ? TVS_2025_BAREME.air : TVS_2025_BAREME.co2;
        
        for (let tranche of bareme) {
          if (co2 <= tranche.max) {
            tarifUnitaire = tranche.tarif;
            break;
          }
        }
      }
      
      // Calcul automatique des trimestres civils entamés
      const calculateTrimestres = () => {
        if (!dateAchat) return 4; // Par défaut, toute l'année
        
        const debut = new Date(dateAchat);
        const fin = dateVente ? new Date(dateVente) : new Date('2025-12-31');
        
        // Calculer le trimestre de début (1 = janv-mars, 2 = avril-juin, 3 = juil-sept, 4 = oct-déc)
        const trimestreDebut = Math.floor(debut.getMonth() / 3) + 1;
        const trimestreFin = Math.floor(fin.getMonth() / 3) + 1;
        
        // Si même année
        if (debut.getFullYear() === fin.getFullYear()) {
          return trimestreFin - trimestreDebut + 1;
        }
        
        // Si années différentes, compter tous les trimestres entre les deux
        const anneeDebut = debut.getFullYear();
        const anneeFin = fin.getFullYear();
        
        // Trimestres restants dans l'année de début
        const trimestresDebut = 5 - trimestreDebut;
        // Trimestres complets des années intermédiaires
        const annéesCompletesEntreDebut = Math.max(0, anneeFin - anneeDebut - 1);
        const trimestresAnneesCompletes = annéesCompletesEntreDebut * 4;
        // Trimestres dans l'année de fin
        const trimestresFin = trimestreFin;
        
        return trimestresDebut + trimestresAnneesCompletes + trimestresFin;
      };
      
      const trimestres = calculateTrimestres();
      const montantAnnuel = tarifUnitaire * (puissance || 1) * trimestres;
      
      return {
        tarifUnitaire,
        montantAnnuel: Math.round(montantAnnuel * 100) / 100,
        bareme: type === 'electrique' || type === 'hydrogene' ? 'Électrique' : (anneeCirculation < 2020 ? 'Air' : 'CO2'),
        trimestres
      };
    }
    
    // ==================== GESTION DES CYCLES DE RÉVISION CONFIGURABLES ====================
    // Fonctions pour charger/sauvegarder les cycles configurés
    const getConfiguredCyclesSimple = () => {
      const saved = localStorage.getItem('cyclesRevisionSimplifiee');
      return saved ? JSON.parse(saved) : CYCLES_REVISION_SIMPLIFIEE;
    };
    
    const getConfiguredCyclesAnnuelle = () => {
      const saved = localStorage.getItem('cyclesRevisionAnnuelle');
      return saved ? JSON.parse(saved) : CYCLES_REVISION_ANNUELLE;
    };
    
    const saveConfiguredCyclesSimple = (cycles) => {
      localStorage.setItem('cyclesRevisionSimplifiee', JSON.stringify(cycles));
    };
    
    const saveConfiguredCyclesAnnuelle = (cycles) => {
      localStorage.setItem('cyclesRevisionAnnuelle', JSON.stringify(cycles));
    };
    
    // ==================== CYCLES DE RÉVISION ====================
    const CYCLES_REVISION_SIMPLIFIEE = [
      {
        name: "CONTRÔLES DE BASE",
        diligences: [
          { description: "Le rapprochement bancaire est-il effectué ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes fournisseurs et clients sont-ils lettrés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "La TVA est-elle contrôlée et justifiée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les charges et produits sont-ils cohérents ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "VALIDATION FINALE",
        diligences: [
          { description: "La balance générale est-elle éditée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le bilan et compte de résultat sont-ils cohérents ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les déclarations fiscales sont-elles prêtes ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      }
    ];
    
    const CYCLES_REVISION_ANNUELLE = [
      {
        name: "TRÉSORERIE",
        diligences: [
          { description: "Le rapprochement bancaire a-t-il été effectué pour tous les comptes ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes 580000 (virements internes) sont-ils soldés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes d'attente 47xxxx ont-ils été purgés et justifiés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes 62700000 (frais bancaires) et 5300000 (caisse) ont-ils été vérifiés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "530 - Caisse : Le solde est-il débiteur et cohérent avec l'activité ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "164 - Emprunts : Le solde est-il rapproché avec les tableaux d'amortissement ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "CAPITAUX",
        diligences: [
          { description: "101 - Capital : Le capital a-t-il été vérifié et est conforme aux statuts ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "1061 - Réserve légale : Représente-t-elle 10% du capital (limite) ? Est-elle dotée si 110 le permet ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "455 - Comptes courants d'associés : Les mouvements sont-ils analysés ? Le solde est-il créditeur ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "108 - Compte de l'exploitant : Vérifier la cohérence avec les prélèvements personnels", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "FOURNISSEURS",
        diligences: [
          { description: "Le compte 401000 a-t-il été lettré ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes 40xxxx hors 401000 ont-ils été justifiés et les comptes soldés supprimés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le compte 408000 a-t-il été justifié et soldé si possible ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Vérification de la cohérence entre balance fournisseurs et échéancier", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "CLIENTS",
        diligences: [
          { description: "Le compte 411000 a-t-il été lettré ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes 41xxxx hors 411000 ont-ils été justifiés et les comptes soldés supprimés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le compte 418000 a-t-il été justifié et soldé si possible ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les créances douteuses ont-elles été identifiées et provisionnées ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "CHARGES",
        diligences: [
          { description: "Le plan de comptes a-t-il été vérifié dans les comptes généraux et les comptes de charges ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les totaux de la classe 6 sont-ils cohérents avec l'exercice précédent ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le contrôle des charges sur factures non parvenues a-t-il été effectué ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les charges significatives non habituelles ont-elles été justifiées ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les charges à répartir et charges constatées d'avance ont-elles été vérifiées ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "PRODUITS",
        diligences: [
          { description: "Le plan de comptes a-t-il été vérifié dans les comptes généraux et les comptes de produits ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les totaux de la classe 7 sont-ils cohérents avec l'exercice précédent ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le contrôle des factures à établir a-t-il été effectué ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les produits significatifs non habituels ont-ils été justifiés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les produits constatés d'avance ont-ils été comptabilisés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "IMMOBILISATIONS",
        diligences: [
          { description: "La cohérence des mouvements d'immobilisations a-t-elle été vérifiée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le fichier des immobilisations est-il à jour ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les dotations aux amortissements ont-elles été comptabilisées ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les immobilisations mises au rebut ont-elles été sorties ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "PERSONNEL & CHARGES SOCIALES",
        diligences: [
          { description: "Le bilan social a-t-il été édité et contrôlé ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes de personnel et organismes sociaux sont-ils soldés ou justifiés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les provisions pour congés payés ont-elles été calculées et comptabilisées ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les cotisations sociales du dernier mois sont-elles comptabilisées en charges à payer ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "TVA",
        diligences: [
          { description: "La TVA a-t-elle été vérifiée et justifiée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le paramétrage de la TVA est-il correct ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les comptes de TVA sont-ils soldés ou justifiés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le rapprochement entre TVA collectée et CA a-t-il été effectué ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "IMPÔTS & TAXES",
        diligences: [
          { description: "L'IS prévisionnel a-t-il été calculé et comptabilisé ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "La CVAE a-t-elle été vérifiée et comptabilisée si nécessaire ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "La CFE a-t-elle été comptabilisée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les crédits d'impôts ont-ils été identifiés et comptabilisés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "EMPRUNTS",
        diligences: [
          { description: "Les tableaux d'amortissement sont-ils à jour ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les intérêts courus ont-ils été comptabilisés ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "La répartition long terme / court terme est-elle correcte ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le rapprochement entre tableau d'amortissement et comptabilité est-il effectué ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      },
      {
        name: "RÉVISION FINALE",
        diligences: [
          { description: "La balance générale définitive a-t-elle été éditée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le bilan et le compte de résultat sont-ils cohérents ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Les annexes ont-elles été préparées ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le dossier de révision est-il complet ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "La liasse fiscale a-t-elle été générée et contrôlée ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" },
          { description: "Le rapport de gestion a-t-il été préparé ?", oui: false, non: false, na: false, dateModif: "", controleur: "", observations: "" }
        ]
      }
    ];
    
    const INITIAL_DOSSIERS = [
      {
        id: 1,
        number: 'VLB001',
        siren: '123456789',
        siret: '12345678900012',
        name: 'SARL TECHNO PLUS',
        activite: 'Services informatiques',
        cloture: '31/12/2024',
        regimeFiscal: 'IS',
        agency: 'villiers-le-bel',
        tva: {
          regime: 'Réel normal',
          periodicite: 'Mensuelle',
          jour: '19',
          type: 'Débit',
          statut: 'Relance',
          notes: 'En attente documents Q3'
        },
        cfe: { actif: true, statut: 'To do', notes: 'À faire avant fin novembre' },
        tvs: {
          actif: true,
          vehicules: [
            { immat: 'AB-123-CD', modele: 'Renault Clio', type: 'essence', puissance: 5, co2: 115, anneeCirculation: 2021, trimestres: 4, dateAchat: '2021-03-15', dateVente: '' }
          ]
        },
        irpp: { actif: false, notes: '' },
        revision: { statut: 'En cours', cycles: ['Banque', 'Immobilisations'] }
      },
      {
        id: 2,
        number: 'VLB002',
        siren: '987654321',
        siret: '98765432100015',
        name: 'SAS BATIMENT MODERNE',
        activite: 'Construction',
        cloture: '30/06/2025',
        regimeFiscal: 'IS',
        agency: 'villiers-le-bel',
        tva: {
          regime: 'Réel normal',
          periodicite: 'Mensuelle',
          jour: '24',
          type: 'Encaissement',
          statut: 'EDI'
        },
        cfe: { actif: true, statut: 'Validé', notes: 'Payé' },
        tvs: {
          actif: true,
          vehicules: [
            { immat: 'EF-456-GH', modele: 'Peugeot Partner', type: 'diesel', puissance: 6, co2: 135, anneeCirculation: 2022, trimestres: 4, dateAchat: '2022-01-10', dateVente: '' }
          ]
        },
        irpp: { actif: false, notes: '' },
        revision: { statut: 'Validé', cycles: ['Banque', 'Immobilisations', 'Stocks'] }
      },
      {
        id: 3,
        number: 'BLE001',
        siren: '555666777',
        siret: '55566677700018',
        name: 'EURL COMMERCE 95',
        activite: 'Commerce de détail',
        cloture: '31/12/2024',
        regimeFiscal: 'IR',
        agency: 'bleue',
        tva: {
          regime: 'Réel simplifié',
          periodicite: 'Annuelle',
          jour: '',
          type: 'Débit',
          statut: 'Attente'
        },
        cfe: { actif: true, statut: 'To do', notes: '' },
        tvs: { actif: false, vehicules: [] },
        irpp: { actif: true, notes: '2035 à faire' },
        revision: { statut: 'Non commencé', cycles: [] }
      }
    ];
    
    // ==================== TOAST COMPONENT ====================
    function Toast({ message, type, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 4000);
        return () => clearTimeout(timer);
      }, [onClose]);
      
      return (
        <div className={`toast ${type}`}>
          <span style={{ fontSize: '20px' }}>
            {type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ'}
          </span>
          <span style={{ flex: 1, fontWeight: 500 }}>{message}</span>
          <button onClick={onClose} style={{ border: 0, background: 'transparent', cursor: 'pointer', fontSize: '18px', color: 'var(--muted)' }}>✕</button>
        </div>
      );
    }
    
    // ==================== MAIN APP ====================
    function App() {
      const [currentUser, setCurrentUser] = useState(ALL_USERS[0]); // Admin par défaut
      const [activeTab, setActiveTab] = useState('dashboard');
      const [dossiers, setDossiers] = useState(INITIAL_DOSSIERS);
      const [users, setUsers] = useState(ALL_USERS);
      const [agencies, setAgencies] = useState(AGENCIES);
      const [searchQuery, setSearchQuery] = useState('');
      const [agencyFilter, setAgencyFilter] = useState('all');
      const [selectedDossier, setSelectedDossier] = useState(null);
      const [showDossierModal, setShowDossierModal] = useState(false);
      const [toast, setToast] = useState(null);
      
      // Filtrage des dossiers selon user et filtres
      const filteredDossiers = useMemo(() => {
        return dossiers.filter(d => {
          // Si l'user a "tous", voir tous les dossiers
          if (currentUser.agences.includes('tous')) return true;
          
          if (!currentUser.agences.includes(d.agency)) return false;
          if (agencyFilter !== 'all' && d.agency !== agencyFilter) return false;
          
          if (searchQuery) {
            const q = searchQuery.toLowerCase();
            return d.number.toLowerCase().includes(q) ||
                   d.name.toLowerCase().includes(q) ||
                   d.siren.includes(q) ||
                   d.siret.includes(q);
          }
          
          return true;
        });
      }, [dossiers, currentUser, agencyFilter, searchQuery]);
      
      const showToast = (message, type = 'success') => {
        setToast({ message, type });
      };
      
      const saveDossier = (dossierData) => {
        if (dossierData.id) {
          setDossiers(dossiers.map(d => d.id === dossierData.id ? dossierData : d));
          showToast('Dossier mis à jour avec succès');
        } else {
          const newDossier = { ...dossierData, id: Date.now() };
          setDossiers([...dossiers, newDossier]);
          showToast('Dossier créé avec succès');
        }
        setShowDossierModal(false);
        setSelectedDossier(null);
      };
      
      const editDossier = (dossier) => {
        setSelectedDossier(dossier);
        setShowDossierModal(true);
      };
      
      const updateTVAStatut = (dossierId, newStatut) => {
        setDossiers(dossiers.map(d => {
          if (d.id === dossierId) {
            return {
              ...d,
              tva: {
                ...d.tva,
                statut: newStatut
              }
            };
          }
          return d;
        }));
        showToast(`Statut TVA modifié : ${newStatut}`);
      };
      
      const updateCFEStatut = (dossierId, newStatut) => {
        setDossiers(dossiers.map(d => {
          if (d.id === dossierId) {
            return {
              ...d,
              cfe: {
                ...d.cfe,
                statut: newStatut
              }
            };
          }
          return d;
        }));
        showToast(`Statut CFE modifié : ${newStatut}`);
      };
      
      // Gestion des agences disponibles pour l'user
      const availableAgencies = useMemo(() => {
        if (currentUser.agences.includes('tous')) {
          return agencies;
        }
        return agencies.filter(a => currentUser.agences.includes(a.id));
      }, [currentUser, agencies]);
      
      return (
        <>
          <div className="topbar">
            <div className="userbar">
              <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                <span style={{ fontSize: '24px' }}>👤</span>
                <div>
                  <div style={{ fontWeight: 700, fontSize: '14px' }}>
                    {currentUser.prenom} {currentUser.nom}
                  </div>
                  <div style={{ fontSize: '12px', color: 'var(--muted)' }}>{currentUser.role}</div>
                </div>
              </div>
              <div style={{ display: 'flex', gap: '8px', flexWrap: 'nowrap', overflow: 'hidden' }}>
                {availableAgencies.map(ag => (
                  <span key={ag.id} className="pill" style={{ background: ag.color + '15', color: ag.color, borderColor: ag.color }}>
                    {ag.name}
                  </span>
                ))}
              </div>
            </div>
            
            <div className="tabs">
              <button 
                className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`}
                onClick={() => setActiveTab('dashboard')}
              >
                📊 Dashboard
              </button>
              <button 
                className={`tab ${activeTab === 'dossiers' ? 'active' : ''}`}
                onClick={() => setActiveTab('dossiers')}
              >
                📁 Dossiers
              </button>
              <button 
                className={`tab ${activeTab === 'tva' ? 'active' : ''}`}
                onClick={() => setActiveTab('tva')}
              >
                💰 TVA
              </button>
              <button 
                className={`tab ${activeTab === 'cfe' ? 'active' : ''}`}
                onClick={() => setActiveTab('cfe')}
              >
                🏢 CFE
              </button>
              <button 
                className={`tab ${activeTab === 'tvs' ? 'active' : ''}`}
                onClick={() => setActiveTab('tvs')}
              >
                🚗 TVS
              </button>
              <button 
                className={`tab ${activeTab === 'revision-simple' ? 'active' : ''}`}
                onClick={() => setActiveTab('revision-simple')}
              >
                📋 Révision Simplifiée
              </button>
              <button 
                className={`tab ${activeTab === 'revision-annuelle' ? 'active' : ''}`}
                onClick={() => setActiveTab('revision-annuelle')}
              >
                📊 Révision Annuelle
              </button>
              <button 
                className={`tab ${activeTab === 'calendar' ? 'active' : ''}`}
                onClick={() => setActiveTab('calendar')}
              >
                📅 Calendrier
              </button>
              {currentUser.role === 'Admin' && (
                <button 
                  className={`tab ${activeTab === 'admin' ? 'active' : ''}`}
                  onClick={() => setActiveTab('admin')}
                >
                  ⚙️ Administration
                </button>
              )}
            </div>
          </div>
          
          <div className="wrap">
            {activeTab === 'dashboard' && (
              <DashboardView dossiers={filteredDossiers} agencies={availableAgencies} currentUser={currentUser} />
            )}
            
            {activeTab === 'dossiers' && (
              <DossiersView 
                dossiers={filteredDossiers}
                agencies={availableAgencies}
                searchQuery={searchQuery}
                setSearchQuery={setSearchQuery}
                agencyFilter={agencyFilter}
                setAgencyFilter={setAgencyFilter}
                onEdit={editDossier}
                onNew={() => { setSelectedDossier(null); setShowDossierModal(true); }}
                currentUser={currentUser}
                users={users}
              />
            )}
            
            {activeTab === 'tva' && (
              <TVAView 
                dossiers={filteredDossiers}
                onEdit={editDossier}
                onUpdateStatut={updateTVAStatut}
                agencies={availableAgencies}
              />
            )}
            
            {activeTab === 'cfe' && (
              <CFEView 
                dossiers={filteredDossiers}
                onEdit={editDossier}
                onUpdateStatut={updateCFEStatut}
                agencies={availableAgencies}
              />
            )}
            
            {activeTab === 'tvs' && (
              <TVSView 
                dossiers={filteredDossiers}
                onEdit={editDossier}
                agencies={availableAgencies}
              />
            )}
            
            {activeTab === 'revision-simple' && (
              <RevisionSimplifieeView 
                dossiers={filteredDossiers}
                onEdit={editDossier}
                agencies={availableAgencies}
                currentUser={currentUser}
                saveDossier={saveDossier}
              />
            )}
            
            {activeTab === 'revision-annuelle' && (
              <RevisionAnnuelleMainView 
                dossiers={filteredDossiers}
                onEdit={editDossier}
                agencies={availableAgencies}
                currentUser={currentUser}
                saveDossier={saveDossier}
              />
            )}
            
            {activeTab === 'calendar' && (
              <CalendarView 
                dossiers={filteredDossiers}
                agencies={availableAgencies}
                users={users}
                currentUser={currentUser}
              />
            )}
            
            {activeTab === 'admin' && currentUser.role === 'Admin' && (
              <AdminView 
                users={users}
                setUsers={setUsers}
                agencies={agencies}
                setAgencies={setAgencies}
                dossiers={dossiers}
                setDossiers={setDossiers}
                showToast={showToast}
              />
            )}
          </div>
          
          {showDossierModal && (
            <DossierModal
              dossier={selectedDossier}
              onSave={saveDossier}
              onClose={() => { setShowDossierModal(false); setSelectedDossier(null); }}
              agencies={availableAgencies}
              currentUser={currentUser}
            />
          )}
          
          {toast && (
            <Toast
              message={toast.message}
              type={toast.type}
              onClose={() => setToast(null)}
            />
          )}
        </>
      );
    }
    
    // ==================== DASHBOARD VIEW ====================
    function DashboardView({ dossiers, agencies, currentUser }) {
      return (
        <div style={{ paddingTop: '20px' }}>
          <h1 style={{ fontSize: '28px', fontWeight: 800, marginBottom: '24px' }}>
            📊 Dashboard — Vue d'ensemble
          </h1>
          
          <div className="panel">
            <h3 style={{ fontSize: '18px', fontWeight: 700, marginBottom: '16px' }}>
              📁 Dossiers actifs
            </h3>
            <div style={{ fontSize: '48px', fontWeight: 800, color: 'var(--brand)', marginBottom: '8px' }}>
              {dossiers.length}
            </div>
            <div style={{ fontSize: '14px', color: 'var(--muted)' }}>
              Dossiers sur {agencies.length} agence{agencies.length > 1 ? 's' : ''}
            </div>
          </div>
          
          <div className="panel" style={{ marginTop: '20px' }}>
            <h3 style={{ fontSize: '18px', fontWeight: 700, marginBottom: '16px' }}>
              📍 Répartition par agence
            </h3>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '12px' }}>
              {agencies.filter(a => a.id !== 'tous').map(agency => {
                const agDossiers = dossiers.filter(d => d.agency === agency.id);
                const nbTVA = agDossiers.filter(d => d.tva.regime !== 'Franchise en base').length;
                const nbCFE = agDossiers.filter(d => d.cfe.actif).length;
                const nbTVS = agDossiers.filter(d => d.tvs.actif).length;
                const nbIRPP = agDossiers.filter(d => d.irpp.actif).length;
                return (
                  <div key={agency.id} style={{ 
                    padding: '10px', 
                    border: '2px solid ' + agency.color + '40', 
                    borderRadius: '8px',
                    background: agency.color + '08'
                  }}>
                    <div style={{ fontWeight: 700, fontSize: '12px', color: agency.color, marginBottom: '4px' }}>
                      {agency.name}
                    </div>
                    <div style={{ fontSize: '20px', fontWeight: 800, marginBottom: '2px' }}>
                      {agDossiers.length}
                    </div>
                    <div style={{ fontSize: '9px', color: 'var(--muted)', marginBottom: '4px' }}>
                      dossiers actifs
                    </div>
                    <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap', marginTop: '4px' }}>
                      {nbTVA > 0 && <span style={{ fontSize: '8px', padding: '2px 4px', borderRadius: '3px', background: '#dbeafe', color: '#1e40af', fontWeight: 600 }}>TVA: {nbTVA}</span>}
                      {nbCFE > 0 && <span style={{ fontSize: '8px', padding: '2px 4px', borderRadius: '3px', background: '#fef3c7', color: '#92400e', fontWeight: 600 }}>CFE: {nbCFE}</span>}
                      {nbTVS > 0 && <span style={{ fontSize: '8px', padding: '2px 4px', borderRadius: '3px', background: '#fce7f3', color: '#9f1239', fontWeight: 600 }}>TVS: {nbTVS}</span>}
                      {nbIRPP > 0 && <span style={{ fontSize: '8px', padding: '2px 4px', borderRadius: '3px', background: '#e0e7ff', color: '#4338ca', fontWeight: 600 }}>IRPP: {nbIRPP}</span>}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    }
    
    // ==================== DOSSIERS VIEW (AVEC PICTOS TEXTE) ====================
    function DossiersView({ dossiers, agencies, searchQuery, setSearchQuery, agencyFilter, setAgencyFilter, onEdit, onNew, currentUser, users }) {
      return (
        <div style={{ paddingTop: '20px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h1 style={{ fontSize: '28px', fontWeight: 800 }}>📁 Dossiers</h1>
            <button className="btn primary" onClick={onNew}>
              ➕ Nouveau dossier
            </button>
          </div>
          
          <div className="toolbar">
            <div className="search">
              <span>🔍</span>
              <input
                type="text"
                placeholder="Rechercher par n°, nom, SIREN, SIRET..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </div>
            
            <select
              className="btn"
              value={agencyFilter}
              onChange={(e) => setAgencyFilter(e.target.value)}
              style={{ 
                minWidth: '140px',
                maxWidth: '160px',
                background: '#e0f2fe',
                color: '#0369a1',
                borderColor: '#7dd3fc',
                fontWeight: 600
              }}
            >
              <option value="all">Toutes les agences</option>
              {agencies.filter(a => a.id !== 'tous').map(ag => (
                <option key={ag.id} value={ag.id}>{ag.name}</option>
              ))}
            </select>
          </div>
          
          <div className="panel">
            <table>
              <thead>
                <tr>
                  <th>N° Dossier</th>
                  <th>Responsable</th>
                  <th>Agence</th>
                  <th>Raison Sociale</th>
                  <th>SIREN</th>
                  <th>Activité</th>
                  <th>Régime</th>
                  <th>Rév. Simplifiée</th>
                  <th>Rév. Annuelle</th>
                  <th>Informations</th>
                </tr>
              </thead>
              <tbody>
                {dossiers.map(d => {
                  const agency = agencies.find(a => a.id === d.agency);
                  
                  // Calculer progression révision simplifiée
                  const getProgressRevSimple = () => {
                    if (!d.revision_simple || (d.regimeFiscal !== 'IR' && d.tva.regime !== 'Réel simplifié')) return null;
                    let total = 0, completed = 0;
                    d.revision_simple.cycles.forEach(c => {
                      c.diligences.forEach(dil => {
                        total++;
                        if (dil.oui || dil.non || dil.na) completed++;
                      });
                    });
                    return total > 0 ? Math.round((completed / total) * 100) : 0;
                  };
                  
                  // Calculer progression révision annuelle
                  const getProgressRevAnnuelle = () => {
                    if (!d.revision_annuelle || d.regimeFiscal !== 'IS') return null;
                    let total = 0, completed = 0;
                    d.revision_annuelle.cycles.forEach(c => {
                      c.diligences.forEach(dil => {
                        total++;
                        if (dil.oui || dil.non || dil.na) completed++;
                      });
                    });
                    return total > 0 ? Math.round((completed / total) * 100) : 0;
                  };
                  
                  const progressSimple = getProgressRevSimple();
                  const progressAnnuelle = getProgressRevAnnuelle();
                  
                  return (
                    <tr key={d.id} style={{cursor: 'pointer'}} onClick={() => onEdit(d)}>
                      <td><strong>{d.number}</strong></td>
                      <td>{users && users.find(u => u.id === d.responsable)?.prenom || "-"}</td>
                      <td>
                        {agency && (
                          <span className="pill" style={{ background: agency.color + '20', color: agency.color, borderColor: agency.color, fontWeight: 600 }}>
                            {agency.name}
                          </span>
                        )}
                      </td>
                      <td>{d.name}</td>
                      <td>{d.siren}</td>
                      <td style={{ color: 'var(--muted)', fontSize: '13px' }}>{d.activite}</td>
                      <td>
                        <span className="badge" style={{ 
                          background: d.regimeFiscal === 'IS' ? '#dbeafe' : '#fef3c7',
                          color: d.regimeFiscal === 'IS' ? '#1e40af' : '#92400e',
                          borderColor: d.regimeFiscal === 'IS' ? '#93c5fd' : '#fcd34d'
                        }}>
                          {d.regimeFiscal}
                        </span>
                      </td>
                      <td style={{ textAlign: 'center' }}>
                        {progressSimple !== null ? (
                          <div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}}>
                            <div className="progress" style={{width: '80px'}}>
                              <i style={{
                                width: `${progressSimple}%`, 
                                background: progressSimple >= 67 ? '#22c55e' : progressSimple >= 34 ? '#3b82f6' : '#ef4444'
                              }}></i>
                            </div>
                            <span style={{
                              fontSize: '11px', 
                              fontWeight: 700, 
                              color: progressSimple >= 67 ? '#16a34a' : progressSimple >= 34 ? '#1e40af' : '#dc2626'
                            }}>
                              {progressSimple}%
                            </span>
                          </div>
                        ) : (
                          <span style={{ color: 'var(--na)', fontSize: '12px' }}>-</span>
                        )}
                      </td>
                      <td style={{ textAlign: 'center' }}>
                        {progressAnnuelle !== null ? (
                          <div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}}>
                            <div className="progress" style={{width: '80px'}}>
                              <i style={{
                                width: `${progressAnnuelle}%`, 
                                background: progressAnnuelle >= 67 ? '#22c55e' : progressAnnuelle >= 34 ? '#3b82f6' : '#ef4444'
                              }}></i>
                            </div>
                            <span style={{
                              fontSize: '11px', 
                              fontWeight: 700, 
                              color: progressAnnuelle >= 67 ? '#16a34a' : progressAnnuelle >= 34 ? '#1e40af' : '#dc2626'
                            }}>
                              {progressAnnuelle}%
                            </span>
                          </div>
                        ) : (
                          <span style={{ color: 'var(--na)', fontSize: '12px' }}>-</span>
                        )}
                      </td>
                      <td>
                        <div className="picto-cell">
                          {d.cfe.actif && <span className="picto-badge picto-cfe">CFE</span>}
                          {d.tvs.actif && <span className="picto-badge picto-tvs">TVS</span>}
                          {d.irpp.actif && <span className="picto-badge picto-irpp">IRPP</span>}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
            
            {dossiers.length === 0 && (
              <div style={{ padding: '60px', textAlign: 'center', color: 'var(--muted)' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>📁</div>
                <div style={{ fontSize: '16px', fontWeight: 600 }}>Aucun dossier trouvé</div>
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // ==================== TVA VIEW ====================
    function TVAView({ dossiers, onEdit, onUpdateStatut, agencies }) {
      const [selectedDossiers, setSelectedDossiers] = React.useState([]);
      const [massStatut, setMassStatut] = React.useState('');
      const tvaActifs = dossiers.filter(d => d.tva.regime !== 'Franchise en base');
      
      const getStatutBadge = (statut) => {
        const badges = {
          'Relance': 'status-relance',
          'Attente': 'status-attente',
          'Saisie': 'status-saisie',
          'Contrôle': 'status-controle',
          'EDI': 'status-edi',
          'OK': 'status-ok'
        };
        return badges[statut] || 'status-attente';
      };
      
      const statutOptions = ['Relance', 'Attente', 'Saisie', 'Contrôle', 'EDI', 'OK'];
      
      const toggleSelection = (id) => {
        if (selectedDossiers.includes(id)) {
          setSelectedDossiers(selectedDossiers.filter(d => d !== id));
        } else {
          setSelectedDossiers([...selectedDossiers, id]);
        }
      };
      
      const selectAll = () => {
        if (selectedDossiers.length === tvaActifs.length) {
          setSelectedDossiers([]);
        } else {
          setSelectedDossiers(tvaActifs.map(d => d.id));
        }
      };
      
      const applyMassStatut = () => {
        if (massStatut && selectedDossiers.length > 0) {
          selectedDossiers.forEach(id => {
            onUpdateStatut(id, massStatut);
          });
          setSelectedDossiers([]);
          setMassStatut('');
        }
      };
      
      return (
        <div style={{ paddingTop: '20px' }}>
          <h1 style={{ fontSize: '28px', fontWeight: 800, marginBottom: '20px' }}>
            💰 Gestion TVA
          </h1>
          
          {selectedDossiers.length > 0 && (
            <div className="panel" style={{ marginBottom: '16px', padding: '16px', background: '#f0f4ff' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{ fontWeight: 600 }}>
                  {selectedDossiers.length} dossier(s) sélectionné(s)
                </span>
                <select
                  className="btn"
                  value={massStatut}
                  onChange={(e) => setMassStatut(e.target.value)}
                  style={{ minWidth: '150px' }}
                >
                  <option value="">Changer le statut...</option>
                  {statutOptions.map(opt => (
                    <option key={opt} value={opt}>{opt}</option>
                  ))}
                </select>
                <button 
                  className="btn primary"
                  onClick={applyMassStatut}
                  disabled={!massStatut}
                >
                  Appliquer
                </button>
                <button 
                  className="btn"
                  onClick={() => setSelectedDossiers([])}
                >
                  Annuler
                </button>
              </div>
            </div>
          )}
          
          <div className="panel">
            <table>
              <thead>
                <tr>
                  <th style={{ width: '40px' }}>
                    <input 
                      type="checkbox" 
                      checked={selectedDossiers.length === tvaActifs.length && tvaActifs.length > 0}
                      onChange={selectAll}
                      style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                    />
                  </th>
                  <th>Dossier</th>
                  <th>Agence</th>
                  <th>Client</th>
                  <th>Régime</th>
                  <th>Périodicité</th>
                  <th>Type</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                {tvaActifs.map(d => {
                  const agency = agencies.find(a => a.id === d.agency);
                  
                  return (
                    <tr key={d.id} style={{ background: selectedDossiers.includes(d.id) ? '#f0f4ff' : 'transparent' }}>
                      <td>
                        <input 
                          type="checkbox" 
                          checked={selectedDossiers.includes(d.id)}
                          onChange={() => toggleSelection(d.id)}
                          onClick={(e) => e.stopPropagation()}
                          style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                        />
                      </td>
                      <td><strong>{d.number}</strong></td>
                      <td>
                        {agency && (
                          <span className="pill" style={{ background: agency.color + '15', color: agency.color, borderColor: agency.color, fontSize: '11px', padding: '4px 8px' }}>
                            {agency.name}
                          </span>
                        )}
                      </td>
                      <td>{d.name}</td>
                      <td>
                        <span className="badge" style={{ fontSize: '11px' }}>
                          {d.tva.regime}
                        </span>
                      </td>
                      <td>{d.tva.periodicite}</td>
                      <td>
                        <span className="badge" style={{ fontSize: '11px' }}>
                          {d.tva.type}
                        </span>
                      </td>
                      <td>
                        <select
                          value={d.tva.statut}
                          onChange={(e) => {
                            e.stopPropagation();
                            onUpdateStatut(d.id, e.target.value);
                          }}
                          className={`status-badge ${getStatutBadge(d.tva.statut)}`}
                          style={{ cursor: 'pointer', border: 'none' }}
                        >
                          {statutOptions.map(opt => (
                            <option key={opt} value={opt}>{opt}</option>
                          ))}
                        </select>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
            
            {tvaActifs.length === 0 && (
              <div style={{ padding: '60px', textAlign: 'center', color: 'var(--muted)' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>💰</div>
                <div style={{ fontSize: '16px', fontWeight: 600 }}>Aucun dossier TVA actif</div>
              </div>
            )}
          </div>
        </div>
      );
    }
    
    // ==================== CFE VIEW ====================
    function CFEView({ dossiers, onEdit, onUpdateStatut, agencies }) {
      const cfeActifs = dossiers.filter(d => d.cfe.actif);
      
      return (
        <div style={{ paddingTop: '20px' }}>
          <h1 style={{ fontSize: '28px', fontWeight: 800, marginBottom: '20px' }}>
            🏢 Cotisation Foncière des Entreprises
          </h1>
          
          <div className="panel">
            <table>
              <thead>
                <tr>
                  <th>Dossier</th>
                  <th>Agence</th>
                  <th>Client</th>
                  <th>Statut</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {cfeActifs.map(d => {
                  const agency = agencies.find(a => a.id === d.agency);
                  return (
                    <tr key={d.id}>
                      <td><strong>{d.number}</strong></td>
                      <td>
                        {agency && (
                          <span className="pill" style={{ background: agency.color + '15', color: agency.color, borderColor: agency.color, fontSize: '11px', padding: '4px 8px' }}>
                            {agency.name}
                          </span>
                        )}
                      </td>
                      <td>{d.name}</td>
                      <td>
                        <select
                          value={d.cfe.statut}
                          onChange={(e) => {
                            e.stopPropagation();
                            onUpdateStatut(d.id, e.target.value);
                          }}
                          className="badge"
                          style={{ 
                            cursor: 'pointer',
                            background: d.cfe.statut === 'Validé' ? '#d1fae5' : '#fef3c7',
                            color: d.cfe.statut === 'Validé' ? '#065f46' : '#92400e',
                            borderColor: d.cfe.statut === 'Validé' ? '#6ee7b7' : '#fcd34d'
                          }}
                        >
                          <option value="To do">To do</option>
                          <option value="Validé">Validé</option>
                        </select>
                      </td>
                      <td style={{ fontSize: '12px', color: 'var(--muted)', maxWidth: '300px' }}>
                        {d.cfe.notes || '-'}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }
    
    // ==================== TVS VIEW ====================
    function TVSView({ dossiers, onEdit, agencies }) {
      const dossiersAvecTVS = dossiers.filter(d => d.tvs.actif && d.tvs.vehicules && d.tvs.vehicules.length > 0);
      
      return (
        <div style={{ paddingTop: '20px' }}>
          <h1 style={{ fontSize: '28px', fontWeight: 800, marginBottom: '20px' }}>
            🚗 Taxe sur les Véhicules de Société
          </h1>
          
          <div className="panel">
            <table>
              <thead>
                <tr>
                  <th>Dossier</th>
                  <th>Agence</th>
                  <th>Client</th>
                  <th>Nb Véhicules</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {dossiersAvecTVS.map(d => {
                  const agency = agencies.find(a => a.id === d.agency);
                  const nbVehicules = d.tvs.vehicules.length;
                  
                  return (
                    <tr key={d.id} style={{cursor: 'pointer'}} onClick={() => onEdit(d)}>
                      <td><strong>{d.number}</strong></td>
                      <td>
                        {agency && (
                          <span className="pill" style={{ background: agency.color + '15', color: agency.color, borderColor: agency.color, fontSize: '11px', padding: '4px 8px' }}>
                            {agency.name}
                          </span>
                        )}
                      </td>
                      <td>{d.name}</td>
                      <td>
                        <span className="badge" style={{ background: '#fce7f3', color: '#9f1239', borderColor: '#f9a8d4', fontWeight: 700 }}>
                          🚗 {nbVehicules}
                        </span>
                      </td>
                      <td style={{ fontSize: '12px', color: 'var(--muted)', maxWidth: '300px' }}>
                        {d.tvs.notes || '-'}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }
    
    // ==================== CALENDAR VIEW ====================
    function CalendarView({ dossiers, agencies, users, currentUser }) {
      const [viewMode, setViewMode] = useState('week');
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [selectedUser, setSelectedUser] = useState(currentUser.id);
      const [showRDVModal, setShowRDVModal] = useState(false);
      const [editingRDV, setEditingRDV] = useState(null);
      const [clickedDateTime, setClickedDateTime] = useState(null);
      const [rdvs, setRdvs] = useState([]);
      const [tasks, setTasks] = useState([
        { id: 1, title: 'Vérifier déclarations TVA mensuelles', completed: false },
        { id: 2, title: 'Appel client SARL Dupont', completed: false },
        { id: 3, title: 'Finaliser révision comptable', completed: false }
      ]);
      const [showTaskModal, setShowTaskModal] = useState(false);
      const [editingTask, setEditingTask] = useState(null);
      
      const availableUsers = useMemo(() => {
        if (currentUser.agences.includes('tous')) {
          return users;
        }
        return users.filter(u => 
          u.agences.some(ag => currentUser.agences.includes(ag))
        );
      }, [users, currentUser]);
      
      const generateEvents = () => {
        const events = [];
        rdvs.forEach(rdv => {
          events.push({
            ...rdv,
            type: 'rdv'
          });
        });
        return events;
      };
      
      const events = generateEvents();
      
      const getWeekDays = () => {
        const start = new Date(selectedDate);
        start.setDate(selectedDate.getDate() - selectedDate.getDay() + 1);
        const days = [];
        for (let i = 0; i < 5; i++) { // Lundi à Vendredi seulement
          const day = new Date(start);
          day.setDate(start.getDate() + i);
          days.push(day);
        }
        return days;
      };
      
      const weekDays = viewMode === 'week' ? getWeekDays() : [selectedDate];
      const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven'];
      const hours = Array.from({ length: 13 }, (_, i) => i + 8); // 8h à 20h
      
      const handleTimeSlotClick = (day, hour) => {
        const dateTime = new Date(day);
        dateTime.setHours(hour, 0, 0, 0);
        setClickedDateTime(dateTime);
        setEditingRDV(null);
        setShowRDVModal(true);
      };
      
      const handleEventClick = (event) => {
        setEditingRDV(event);
        setClickedDateTime(null);
        setShowRDVModal(true);
      };
      
      const addRDV = (rdvData) => {
        if (editingRDV) {
          setRdvs(rdvs.map(r => r.id === editingRDV.id ? { ...rdvData, id: editingRDV.id } : r));
        } else {
          setRdvs([...rdvs, { ...rdvData, id: Date.now() }]);
        }
        setShowRDVModal(false);
        setEditingRDV(null);
        setClickedDateTime(null);
      };
      
      const deleteRDV = (id) => {
        setRdvs(rdvs.filter(r => r.id !== id));
        setShowRDVModal(false);
        setEditingRDV(null);
      };
      
      const toggleTask = (id) => {
        setTasks(tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
      };
      
      const addTask = (taskData) => {
        if (editingTask) {
          setTasks(tasks.map(t => t.id === editingTask.id ? { ...taskData, id: editingTask.id } : t));
        } else {
          setTasks([...tasks, { ...taskData, id: Date.now(), completed: false }]);
        }
        setShowTaskModal(false);
        setEditingTask(null);
      };
      
      const deleteTask = (id) => {
        setTasks(tasks.filter(t => t.id !== id));
      };
      
      return (
        <div style={{ paddingTop: '20px' }}>
          <h1 style={{ fontSize: '28px', fontWeight: 800, marginBottom: '20px' }}>
            📅 Calendrier & Rendez-vous
          </h1>
          
          <div className="panel" style={{ marginBottom: '20px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', flexWrap: 'wrap', gap: '12px' }}>
              <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                <button className="btn" onClick={() => {
                  const newDate = new Date(selectedDate);
                  newDate.setDate(selectedDate.getDate() - (viewMode === 'day' ? 1 : 7));
                  setSelectedDate(newDate);
                }}>
                  ◀
                </button>
                <div style={{ fontSize: '18px', fontWeight: 700, minWidth: '220px', textAlign: 'center' }}>
                  {viewMode === 'day' 
                    ? selectedDate.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
                    : `Semaine du ${weekDays[0].toLocaleDateString('fr-FR')} au ${weekDays[4].toLocaleDateString('fr-FR')}`
                  }
                </div>
                <button className="btn" onClick={() => {
                  const newDate = new Date(selectedDate);
                  newDate.setDate(selectedDate.getDate() + (viewMode === 'day' ? 1 : 7));
                  setSelectedDate(newDate);
                }}>
                  ▶
                </button>
                <button className="btn" onClick={() => setSelectedDate(new Date())}>
                  Aujourd'hui
                </button>
              </div>
              
              <div style={{ display: 'flex', gap: '12px' }}>
                <select
                  className="btn"
                  value={viewMode}
                  onChange={(e) => setViewMode(e.target.value)}
                >
                  <option value="day">Vue Jour</option>
                  <option value="week">Vue Semaine</option>
                </select>
                
                <select
                  className="btn"
                  value={selectedUser}
                  onChange={(e) => setSelectedUser(e.target.value)}
                  style={{ minWidth: '200px' }}
                >
                  <option value="all">Tous les collaborateurs</option>
                  {availableUsers.map(u => (
                    <option key={u.id} value={u.id}>
                      {u.prenom} {u.nom}
                    </option>
                  ))}
                </select>
                
                <button className="btn primary" onClick={() => { setEditingRDV(null); setClickedDateTime(null); setShowRDVModal(true); }}>
                  ➕ Prendre RDV
                </button>
              </div>
            </div>
            
            <div className="calendar-layout">
              <div className="calendar-sidebar">
                <div style={{ height: '60px', borderBottom: '1px solid var(--line)' }}></div>
                <div className="calendar-hours">
                  {hours.map(h => (
                    <div key={h} className="calendar-hour">
                      {h}:00
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="calendar-main">
                <div className="calendar-grid-week">
                  {weekDays.map((day, idx) => (
                    <div key={idx} className="calendar-day-col">
                      <div className="calendar-day-header">
                        {dayNames[idx]} {day.getDate()}
                      </div>
                      <div className="calendar-time-slots">
                        {hours.map(hour => (
                          <div
                            key={hour}
                            className="calendar-time-slot"
                            onClick={() => handleTimeSlotClick(day, hour)}
                            style={{ cursor: 'pointer', borderBottom: '1px solid #f0f0f0', height: '60px' }}
                          />
                        ))}
                        {events.filter(e => {
                          const eventDate = new Date(e.date);
                          return eventDate.toDateString() === day.toDateString();
                        }).map((event, i) => {
                          const eventDate = new Date(event.date);
                          const hour = eventDate.getHours();
                          const minute = eventDate.getMinutes();
                          const top = ((hour - 8) * 60 + minute) + 'px';
                          const height = (event.duration || 60) + 'px';
                          
                          return (
                            <div
                              key={i}
                              className={`calendar-event-block ${event.type}`}
                              style={{ top, height, cursor: 'pointer' }}
                              onClick={(e) => { e.stopPropagation(); handleEventClick(event); }}
                              title={event.title}
                            >
                              <div style={{ fontWeight: 700 }}>{eventDate.getHours()}:{eventDate.getMinutes().toString().padStart(2, '0')}</div>
                              <div style={{ fontSize: '10px', marginTop: '2px', fontWeight: 600 }}>{event.title}</div>
                              {event.motif && (
                                <div style={{ fontSize: '9px', color: '#666', fontStyle: 'italic', marginTop: '1px' }}>
                                  {event.motif === 'autre' ? event.motifAutre : 
                                   event.motif === 'bilan' ? '📊 Bilan' :
                                   event.motif === 'paie' ? '💰 Paie' :
                                   event.motif === 'attestations' ? '📄 Attestations' :
                                   event.motif === 'rappel' ? '📞 Rappel' : event.motif}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))}
                </div>
                
                {/* Colonne Alertes & Tâches */}
                <div style={{ 
                  minWidth: '280px', 
                  maxWidth: '280px',
                  marginLeft: '16px',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '12px'
                }}>
                  <div style={{ 
                    background: 'white', 
                    border: '2px solid #fbbf24',
                    borderRadius: '12px', 
                    padding: '16px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                  }}>
                    <h3 style={{ 
                      fontSize: '14px', 
                      fontWeight: 700, 
                      marginBottom: '12px',
                      color: '#d97706',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '6px'
                    }}>
                      🔔 Alertes
                    </h3>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      <div style={{ 
                        padding: '10px', 
                        background: '#fef3c7', 
                        borderRadius: '8px',
                        fontSize: '12px',
                        borderLeft: '3px solid #f59e0b'
                      }}>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>TVA à déposer</div>
                        <div style={{ color: '#92400e' }}>3 dossiers en attente</div>
                      </div>
                      <div style={{ 
                        padding: '10px', 
                        background: '#fee2e2', 
                        borderRadius: '8px',
                        fontSize: '12px',
                        borderLeft: '3px solid #ef4444'
                      }}>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>Échéances proches</div>
                        <div style={{ color: '#991b1b' }}>CFE - 5 dossiers</div>
                      </div>
                      <div style={{ 
                        padding: '10px', 
                        background: '#dbeafe', 
                        borderRadius: '8px',
                        fontSize: '12px',
                        borderLeft: '3px solid #3b82f6'
                      }}>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>Révision en cours</div>
                        <div style={{ color: '#1e40af' }}>8 dossiers actifs</div>
                      </div>
                    </div>
                  </div>
                  
                  <div style={{ 
                    background: 'white', 
                    border: '2px solid #8b5cf6',
                    borderRadius: '12px', 
                    padding: '16px',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.08)'
                  }}>
                    <div style={{ 
                      fontSize: '14px', 
                      fontWeight: 700, 
                      marginBottom: '12px',
                      color: '#7c3aed',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'space-between'
                    }}>
                      <span style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                        ✓ Tâches du jour ({tasks.filter(t => !t.completed).length})
                      </span>
                      <button 
                        className="btn small primary" 
                        onClick={() => { setEditingTask(null); setShowTaskModal(true); }}
                        style={{ padding: '4px 8px', fontSize: '11px' }}
                      >
                        ➕ Nouvelle
                      </button>
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '300px', overflowY: 'auto' }}>
                      {tasks.length === 0 ? (
                        <div style={{ padding: '20px', textAlign: 'center', color: 'var(--muted)', fontSize: '12px' }}>
                          Aucune tâche pour aujourd'hui
                        </div>
                      ) : (
                        tasks.map(task => (
                          <div key={task.id} style={{ 
                            display: 'flex', 
                            alignItems: 'flex-start', 
                            gap: '8px',
                            padding: '8px',
                            background: task.completed ? '#f0fdf4' : '#f5f3ff',
                            borderRadius: '6px',
                            fontSize: '12px',
                            border: task.completed ? '1px solid #86efac' : '1px solid #e9d5ff'
                          }}>
                            <input 
                              type="checkbox" 
                              checked={task.completed}
                              onChange={() => toggleTask(task.id)}
                              style={{ marginTop: '2px', cursor: 'pointer' }} 
                            />
                            <span style={{ 
                              flex: 1, 
                              textDecoration: task.completed ? 'line-through' : 'none',
                              color: task.completed ? '#4ade80' : 'var(--text)',
                              cursor: 'pointer'
                            }} onClick={() => toggleTask(task.id)}>
                              {task.title}
                            </span>
                            <button 
                              className="btn danger" 
                              style={{ padding: '2px 6px', fontSize: '10px', minWidth: 'auto' }}
                              onClick={() => deleteTask(task.id)}
                            >
                              🗑️
                            </button>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {showRDVModal && (
            <RDVModal
              onSave={addRDV}
              onClose={() => { setShowRDVModal(false); setEditingRDV(null); setClickedDateTime(null); }}
              onDelete={editingRDV ? () => deleteRDV(editingRDV.id) : null}
              users={availableUsers}
              dossiers={dossiers}
              selectedDate={selectedDate}
              editingRDV={editingRDV}
              clickedDateTime={clickedDateTime}
              currentUser={currentUser}
            />
          )}
          
          {showTaskModal && (
            <TaskModal
              onSave={addTask}
              onClose={() => { setShowTaskModal(false); setEditingTask(null); }}
              editingTask={editingTask}
            />
          )}
        </div>
      );
    }
    
    // ==================== RDV MODAL ====================
    function RDVModal({ onSave, onClose, onDelete, users, dossiers, selectedDate, editingRDV, clickedDateTime, currentUser }) {
      const initialDate = clickedDateTime || (editingRDV ? new Date(editingRDV.date) : selectedDate);
      
      const [formData, setFormData] = useState({
        date: initialDate.toISOString().split('T')[0],
        time: editingRDV 
          ? `${initialDate.getHours().toString().padStart(2, '0')}:${initialDate.getMinutes().toString().padStart(2, '0')}`
          : clickedDateTime 
            ? `${initialDate.getHours().toString().padStart(2, '0')}:00`
            : '09:00',
        duration: editingRDV?.duration || 60,
        title: editingRDV?.title || '',
        client: editingRDV?.client || '',
        motif: editingRDV?.motif || 'bilan',
        motifAutre: editingRDV?.motifAutre || '',
        userId: editingRDV?.userId || (currentUser?.id || ''),
        notes: editingRDV?.notes || ''
      });
      
      const handleSubmit = (e) => {
        e.preventDefault();
        const datetime = new Date(`${formData.date}T${formData.time}`);
        onSave({
          ...formData,
          date: datetime
        });
      };
      
      const handleClientSelect = (clientName) => {
        setFormData({...formData, title: `RDV ${clientName}`, client: clientName});
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
            <div className="modal-header">
              <h2 style={{fontSize: '20px', fontWeight: 700}}>
                📅 {editingRDV ? 'Modifier le rendez-vous' : 'Prendre un rendez-vous'}
              </h2>
              <button onClick={onClose} className="btn small">✕</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="grid-2">
                  <div className="form-group">
                    <label className="form-label">Date *</label>
                    <input
                      type="date"
                      className="form-control"
                      value={formData.date}
                      onChange={(e) => setFormData({...formData, date: e.target.value})}
                      required
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Heure *</label>
                    <input
                      type="time"
                      className="form-control"
                      value={formData.time}
                      onChange={(e) => setFormData({...formData, time: e.target.value})}
                      required
                    />
                  </div>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Client *</label>
                  <select
                    className="form-control"
                    value={formData.client}
                    onChange={(e) => handleClientSelect(e.target.value)}
                    required
                  >
                    <option value="">Sélectionner un client...</option>
                    {dossiers && dossiers.map(d => (
                      <option key={d.id} value={d.name}>
                        {d.number} - {d.name}
                      </option>
                    ))}
                  </select>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Motif du rendez-vous *</label>
                  <select
                    className="form-control"
                    value={formData.motif}
                    onChange={(e) => setFormData({...formData, motif: e.target.value})}
                    required
                  >
                    <option value="bilan">📊 Bilan</option>
                    <option value="paie">💰 Bulletin de paie</option>
                    <option value="attestations">📄 Attestations</option>
                    <option value="rappel">📞 Rappeler le client</option>
                    <option value="autre">✏️ Autre</option>
                  </select>
                </div>
                
                {formData.motif === 'autre' && (
                  <div className="form-group">
                    <label className="form-label">Précisez le motif *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.motifAutre}
                      onChange={(e) => setFormData({...formData, motifAutre: e.target.value})}
                      placeholder="Ex: Rendez-vous TVA, Préparation CFE..."
                      required
                    />
                  </div>
                )}
                
                <div className="form-group">
                  <label className="form-label">Titre *</label>
                  <input
                    type="text"
                    className="form-control"
                    value={formData.title}
                    onChange={(e) => setFormData({...formData, title: e.target.value})}
                    placeholder="Ex: RDV M. Dupont"
                    required
                  />
                </div>
                
                <div className="grid-2">
                  <div className="form-group">
                    <label className="form-label">Collaborateur *</label>
                    <select
                      className="form-control"
                      value={formData.userId}
                      onChange={(e) => setFormData({...formData, userId: e.target.value})}
                      required
                    >
                      <option value="">Sélectionner...</option>
                      {users.map(u => (
                        <option key={u.id} value={u.id}>
                          {u.prenom} {u.nom}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Durée (min) *</label>
                    <select
                      className="form-control"
                      value={formData.duration}
                      onChange={(e) => setFormData({...formData, duration: parseInt(e.target.value)})}
                      required
                    >
                      <option value="30">30 min</option>
                      <option value="60">1 heure</option>
                      <option value="90">1h30</option>
                      <option value="120">2 heures</option>
                    </select>
                  </div>
                </div>
                
                <div className="form-group">
                  <label className="form-label">Notes</label>
                  <textarea
                    className="form-control"
                    value={formData.notes}
                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                    rows="3"
                    placeholder="Notes complémentaires..."
                  />
                </div>
              </div>
              
              <div className="modal-footer" style={{ display: 'flex', justifyContent: 'space-between' }}>
                <div>
                  {editingRDV && onDelete && (
                    <button type="button" onClick={onDelete} className="btn danger">
                      🗑️ Supprimer
                    </button>
                  )}
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button type="button" onClick={onClose} className="btn">
                    Annuler
                  </button>
                  <button type="submit" className="btn primary">
                    {editingRDV ? 'Modifier' : 'Créer'} le RDV
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // ==================== AFFECTATION EN MASSE ====================
    function AffectationMasse({ users, agencies, dossiers, setDossiers, showToast }) {
      const [selectedAgency, setSelectedAgency] = useState('');
      const [selectedUser, setSelectedUser] = useState('');
      const [selectedDossiers, setSelectedDossiers] = useState([]);
      
      const filteredDossiers = selectedAgency === '' 
        ? [] 
        : dossiers.filter(d => d.agency === selectedAgency);
      
      const agencyUsers = selectedAgency === '' 
        ? [] 
        : users.filter(u => u.agences.includes(selectedAgency));
      
      const handleSelectAll = () => {
        if (selectedDossiers.length === filteredDossiers.length) {
          setSelectedDossiers([]);
        } else {
          setSelectedDossiers(filteredDossiers.map(d => d.id));
        }
      };
      
      const handleToggleDossier = (dossierId) => {
        if (selectedDossiers.includes(dossierId)) {
          setSelectedDossiers(selectedDossiers.filter(id => id !== dossierId));
        } else {
          setSelectedDossiers([...selectedDossiers, dossierId]);
        }
      };
      
      const handleAffect = () => {
        if (!selectedUser || selectedDossiers.length === 0) {
          showToast('Veuillez sélectionner un utilisateur et au moins un dossier', 'warning');
          return;
        }
        
        const user = users.find(u => u.id === selectedUser);
        if (!user) return;
        
        const updatedDossiers = dossiers.map(d => {
          if (selectedDossiers.includes(d.id)) {
            return { ...d, responsable: `${user.prenom} ${user.nom}` };
          }
          return d;
        });
        
        setDossiers(updatedDossiers);
        showToast(`${selectedDossiers.length} dossier(s) affecté(s) à ${user.prenom} ${user.nom}`, 'success');
        setSelectedDossiers([]);
      };
      
      return (
        <div className="panel">
          <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '20px' }}>
            📂 Affectation en masse de dossiers
          </h2>
          
          <p style={{ marginBottom: '20px', color: 'var(--muted)' }}>
            Sélectionnez une agence, puis choisissez les dossiers à affecter à un utilisateur.
          </p>
          
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '20px' }}>
            <div className="form-group">
              <label className="form-label">Agence *</label>
              <select
                className="form-control"
                value={selectedAgency}
                onChange={(e) => {
                  setSelectedAgency(e.target.value);
                  setSelectedUser('');
                  setSelectedDossiers([]);
                }}
              >
                <option value="">Sélectionner une agence...</option>
                {agencies.filter(a => a.id !== 'tous').map(a => (
                  <option key={a.id} value={a.id}>{a.name}</option>
                ))}
              </select>
            </div>
            
            <div className="form-group">
              <label className="form-label">Utilisateur *</label>
              <select
                className="form-control"
                value={selectedUser}
                onChange={(e) => setSelectedUser(e.target.value)}
                disabled={!selectedAgency}
              >
                <option value="">Sélectionner un utilisateur...</option>
                {agencyUsers.map(u => (
                  <option key={u.id} value={u.id}>
                    {u.prenom} {u.nom} ({u.role})
                  </option>
                ))}
              </select>
            </div>
          </div>
          
          {selectedAgency && filteredDossiers.length > 0 && (
            <>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                <h3 style={{ fontSize: '16px', fontWeight: 600 }}>
                  Dossiers de l'agence ({selectedDossiers.length} sélectionné{selectedDossiers.length > 1 ? 's' : ''})
                </h3>
                <button className="btn small" onClick={handleSelectAll}>
                  {selectedDossiers.length === filteredDossiers.length ? '❌ Tout désélectionner' : '✓ Tout sélectionner'}
                </button>
            <button
              className={`sub-tab ${activeSubTab === 'transfert' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('transfert')}
            >
              🔄 Transfert agences
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'archivage' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('archivage')}
            >
              📦 Archivage
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'ajoutRevision' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('ajoutRevision')}
            >
              ➕ Ajout masse révision
            </button>
              </div>
              
              <div style={{ maxHeight: '400px', overflowY: 'auto', border: '1px solid var(--line)', borderRadius: '8px' }}>
                <table>
                  <thead>
                    <tr>
                      <th style={{ width: '50px' }}>
                        <input
                          type="checkbox"
                          checked={selectedDossiers.length === filteredDossiers.length && filteredDossiers.length > 0}
                          onChange={handleSelectAll}
                        />
                      </th>
                      <th>N° Dossier</th>
                      <th>Raison Sociale</th>
                      <th>Régime</th>
                      <th>Responsable actuel</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredDossiers.map(d => (
                      <tr key={d.id} onClick={() => handleToggleDossier(d.id)} style={{ cursor: 'pointer' }}>
                        <td>
                          <input
                            type="checkbox"
                            checked={selectedDossiers.includes(d.id)}
                            onChange={() => handleToggleDossier(d.id)}
                            onClick={(e) => e.stopPropagation()}
                          />
                        </td>
                        <td><strong>{d.number}</strong></td>
                        <td>{d.name}</td>
                        <td>
                          <span className="badge" style={{ 
                            background: d.regimeFiscal === 'IS' ? '#dbeafe' : '#fef3c7',
                            color: d.regimeFiscal === 'IS' ? '#1e40af' : '#92400e',
                            borderColor: d.regimeFiscal === 'IS' ? '#93c5fd' : '#fcd34d'
                          }}>
                            {d.regimeFiscal}
                          </span>
                        </td>
                        <td style={{ color: 'var(--muted)', fontSize: '13px' }}>
                          {d.responsable || 'Non affecté'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              
              <div style={{ marginTop: '20px', display: 'flex', justifyContent: 'flex-end' }}>
                <button 
                  className="btn primary"
                  onClick={handleAffect}
                  disabled={!selectedUser || selectedDossiers.length === 0}
                >
                  ✓ Affecter {selectedDossiers.length > 0 && `(${selectedDossiers.length})`}
                </button>
              </div>
            </>
          )}
          
          {selectedAgency && filteredDossiers.length === 0 && (
            <div style={{ padding: '40px', textAlign: 'center', color: 'var(--muted)' }}>
              Aucun dossier dans cette agence
            </div>
          )}
        </div>
      );
    }
    
    // ==================== REVISION SIMPLE ADMIN ====================
    function RevisionSimpleAdmin({ showToast }) {
      const [cyclesConfig, setCyclesConfig] = useState(getConfiguredCyclesSimple());
      const [editingCycle, setEditingCycle] = useState(null);
      const [editingDiligence, setEditingDiligence] = useState(null);
      
      const saveCycle = (cycleIndex, newName) => {
        const updated = [...cyclesConfig];
        updated[cycleIndex].name = newName;
        setCyclesConfig(updated);
        setEditingCycle(null);
        showToast('Titre du cycle modifié', 'success');
      };
      
      const saveDiligence = (cycleIndex, diligenceIndex, newDescription) => {
        const updated = [...cyclesConfig];
        updated[cycleIndex].diligences[diligenceIndex].description = newDescription;
        setCyclesConfig(updated);
        setEditingDiligence(null);
        showToast('Question modifiée', 'success');
      };
      
      const addDiligence = (cycleIndex) => {
        const updated = [...cyclesConfig];
        updated[cycleIndex].diligences.push({
          description: "Nouvelle question à compléter",
          oui: false, non: false, na: false,
          dateModif: "", controleur: "", observations: ""
        });
        setCyclesConfig(updated);
        showToast('Question ajoutée', 'success');
      };
      
      const deleteDiligence = (cycleIndex, diligenceIndex) => {
        if (!confirm('Supprimer cette question ?')) return;
        const updated = [...cyclesConfig];
        updated[cycleIndex].diligences.splice(diligenceIndex, 1);
        setCyclesConfig(updated);
        showToast('Question supprimée', 'success');
      };
      
      const saveConfiguration = () => {
        saveConfiguredCyclesSimple(cyclesConfig);
        showToast('Configuration sauvegardée avec succès', 'success');
      };
      
      return (
        <div className="panel">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700 }}>📋 Configuration Révision Simplifiée</h2>
            <button className="btn primary" onClick={saveConfiguration}>
              💾 Sauvegarder la configuration
            </button>
          </div>
          
          <p style={{ marginBottom: '20px', color: 'var(--muted)' }}>
            Personnalisez les titres des cycles et les questions pour la révision simplifiée (IR et Réel simplifié).
          </p>
          
          {cyclesConfig.map((cycle, cycleIndex) => (
            <div key={cycleIndex} style={{
              background: '#f7f8fb',
              border: '2px solid var(--line)',
              borderRadius: '12px',
              padding: '20px',
              marginBottom: '16px'
            }}>
              {/* Titre du cycle */}
              <div style={{ marginBottom: '16px', paddingBottom: '12px', borderBottom: '2px solid var(--line)' }}>
                {editingCycle === cycleIndex ? (
                  <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <input
                      type="text"
                      className="form-control"
                      value={cycle.name}
                      onChange={(e) => {
                        const updated = [...cyclesConfig];
                        updated[cycleIndex].name = e.target.value;
                        setCyclesConfig(updated);
                      }}
                      style={{ flex: 1, fontSize: '16px', fontWeight: 700 }}
                    />
                    <button className="btn success small" onClick={() => saveCycle(cycleIndex, cycle.name)}>
                      ✓ Valider
                    </button>
                    <button className="btn small" onClick={() => setEditingCycle(null)}>
                      Annuler
                    </button>
                  </div>
                ) : (
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: 700, margin: 0 }}>{cycle.name}</h3>
                    <button className="btn small" onClick={() => setEditingCycle(cycleIndex)}>
                      ✏️ Modifier le titre
                    </button>
                  </div>
                )}
              </div>
              
              {/* Liste des diligences */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {cycle.diligences.map((diligence, diligenceIndex) => {
                  const editKey = `${cycleIndex}-${diligenceIndex}`;
                  return (
                    <div key={diligenceIndex} style={{
                      background: 'white',
                      padding: '6px 10px',
                      borderRadius: '8px',
                      border: '1px solid var(--line)'
                    }}>
                      {editingDiligence === editKey ? (
                        <div>
                          <textarea
                            className="form-control"
                            value={diligence.description}
                            onChange={(e) => {
                              const updated = [...cyclesConfig];
                              updated[cycleIndex].diligences[diligenceIndex].description = e.target.value;
                              setCyclesConfig(updated);
                            }}
                            rows="2"
                            style={{ width: '100%', marginBottom: '8px' }}
                          />
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <button className="btn success small" 
                              onClick={() => saveDiligence(cycleIndex, diligenceIndex, diligence.description)}>
                              ✓ Valider
                            </button>
                            <button className="btn small" onClick={() => setEditingDiligence(null)}>
                              Annuler
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <div style={{ flex: 1, fontSize: '13px' }}>{diligence.description}</div>
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <button className="btn small" onClick={() => setEditingDiligence(editKey)}>
                              ✏️
                            </button>
                            <button className="btn danger small" onClick={() => deleteDiligence(cycleIndex, diligenceIndex)}>
                              🗑️
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
                
                <button className="btn small" onClick={() => addDiligence(cycleIndex)} style={{ marginTop: '8px' }}>
                  ➕ Ajouter une question
                </button>
              </div>
            </div>
          ))}
        </div>
      );
    }
    
    // ==================== REVISION ANNUELLE ADMIN ====================
    function RevisionAnnuelleAdmin({ showToast }) {
      const [cyclesConfig, setCyclesConfig] = useState(getConfiguredCyclesAnnuelle());
      const [editingCycle, setEditingCycle] = useState(null);
      const [editingDiligence, setEditingDiligence] = useState(null);
      
      const saveCycle = (cycleIndex, newName) => {
        const updated = [...cyclesConfig];
        updated[cycleIndex].name = newName;
        setCyclesConfig(updated);
        setEditingCycle(null);
        showToast('Titre du cycle modifié', 'success');
      };
      
      const saveDiligence = (cycleIndex, diligenceIndex, newDescription) => {
        const updated = [...cyclesConfig];
        updated[cycleIndex].diligences[diligenceIndex].description = newDescription;
        setCyclesConfig(updated);
        setEditingDiligence(null);
        showToast('Question modifiée', 'success');
      };
      
      const addDiligence = (cycleIndex) => {
        const updated = [...cyclesConfig];
        updated[cycleIndex].diligences.push({
          description: "Nouvelle question à compléter",
          oui: false, non: false, na: false,
          dateModif: "", controleur: "", observations: ""
        });
        setCyclesConfig(updated);
        showToast('Question ajoutée', 'success');
      };
      
      const deleteDiligence = (cycleIndex, diligenceIndex) => {
        if (!confirm('Supprimer cette question ?')) return;
        const updated = [...cyclesConfig];
        updated[cycleIndex].diligences.splice(diligenceIndex, 1);
        setCyclesConfig(updated);
        showToast('Question supprimée', 'success');
      };
      
      const saveConfiguration = () => {
        saveConfiguredCyclesAnnuelle(cyclesConfig);
        showToast('Configuration sauvegardée avec succès', 'success');
      };
      
      return (
        <div className="panel">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700 }}>📊 Configuration Révision Annuelle</h2>
            <button className="btn primary" onClick={saveConfiguration}>
              💾 Sauvegarder la configuration
            </button>
          </div>
          
          <p style={{ marginBottom: '20px', color: 'var(--muted)' }}>
            Personnalisez les titres des cycles et les questions pour la révision annuelle (IS - Bilan).
          </p>
          
          {cyclesConfig.map((cycle, cycleIndex) => (
            <div key={cycleIndex} style={{
              background: '#f7f8fb',
              border: '2px solid var(--line)',
              borderRadius: '12px',
              padding: '20px',
              marginBottom: '16px'
            }}>
              {/* Titre du cycle */}
              <div style={{ marginBottom: '16px', paddingBottom: '12px', borderBottom: '2px solid var(--line)' }}>
                {editingCycle === cycleIndex ? (
                  <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <input
                      type="text"
                      className="form-control"
                      value={cycle.name}
                      onChange={(e) => {
                        const updated = [...cyclesConfig];
                        updated[cycleIndex].name = e.target.value;
                        setCyclesConfig(updated);
                      }}
                      style={{ flex: 1, fontSize: '16px', fontWeight: 700 }}
                    />
                    <button className="btn success small" onClick={() => saveCycle(cycleIndex, cycle.name)}>
                      ✓ Valider
                    </button>
                    <button className="btn small" onClick={() => setEditingCycle(null)}>
                      Annuler
                    </button>
                  </div>
                ) : (
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: 700, margin: 0 }}>{cycle.name}</h3>
                    <button className="btn small" onClick={() => setEditingCycle(cycleIndex)}>
                      ✏️ Modifier le titre
                    </button>
                  </div>
                )}
              </div>
              
              {/* Liste des diligences */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {cycle.diligences.map((diligence, diligenceIndex) => {
                  const editKey = `${cycleIndex}-${diligenceIndex}`;
                  return (
                    <div key={diligenceIndex} style={{
                      background: 'white',
                      padding: '6px 10px',
                      borderRadius: '8px',
                      border: '1px solid var(--line)'
                    }}>
                      {editingDiligence === editKey ? (
                        <div>
                          <textarea
                            className="form-control"
                            value={diligence.description}
                            onChange={(e) => {
                              const updated = [...cyclesConfig];
                              updated[cycleIndex].diligences[diligenceIndex].description = e.target.value;
                              setCyclesConfig(updated);
                            }}
                            rows="2"
                            style={{ width: '100%', marginBottom: '8px' }}
                          />
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <button className="btn success small" 
                              onClick={() => saveDiligence(cycleIndex, diligenceIndex, diligence.description)}>
                              ✓ Valider
                            </button>
                            <button className="btn small" onClick={() => setEditingDiligence(null)}>
                              Annuler
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <div style={{ flex: 1, fontSize: '13px' }}>{diligence.description}</div>
                          <div style={{ display: 'flex', gap: '8px' }}>
                            <button className="btn small" onClick={() => setEditingDiligence(editKey)}>
                              ✏️
                            </button>
                            <button className="btn danger small" onClick={() => deleteDiligence(cycleIndex, diligenceIndex)}>
                              🗑️
                            </button>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
                
                <button className="btn small" onClick={() => addDiligence(cycleIndex)} style={{ marginTop: '8px' }}>
                  ➕ Ajouter une question
                </button>
              </div>
            </div>
          ))}
        </div>
      );
    }
    
    // ==================== TASK MODAL ====================
    function TaskModal({ onSave, onClose, editingTask }) {
      const [title, setTitle] = useState(editingTask?.title || '');
      
      const handleSubmit = (e) => {
        e.preventDefault();
        if (title.trim()) {
          onSave({ title: title.trim() });
        }
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px' }}>
            <div className="modal-header">
              <h2 style={{fontSize: '20px', fontWeight: 700}}>
                ✓ {editingTask ? 'Modifier la tâche' : 'Nouvelle tâche'}
              </h2>
              <button onClick={onClose} className="btn small">✕</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">Description de la tâche *</label>
                  <textarea
                    className="form-control"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    placeholder="Ex: Vérifier les déclarations TVA mensuelles"
                    rows="3"
                    required
                    autoFocus
                  />
                </div>
              </div>
              
              <div className="modal-footer">
                <button type="button" onClick={onClose} className="btn">
                  Annuler
                </button>
                <button type="submit" className="btn primary">
                  {editingTask ? 'Modifier' : 'Créer'}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    // ==================== IMPORT DOSSIERS MODAL ====================
    function ImportDossiersModal({ onSave, onClose, agencies, users }) {
      const [importData, setImportData] = useState('');
      const [error, setError] = useState('');

      const downloadTemplate = () => {
        const template = [
          'numero;nom;siren;siret;agency;responsable;regimeFiscal;regimeTVA;periodicite',
          '001;EXEMPLE SARL;123456789;12345678900001;AG001;USER001;IS;Réel normal;Mensuelle',
          '002;TEST SAS;987654321;98765432100001;AG002;USER002;IR;Réel simplifié;Trimestrielle'
        ].join('\n');
        
        const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'modele_import_dossiers.csv';
        link.click();
      };

      const handleImport = () => {
        setError('');
        const lines = importData.trim().split('\n');
        if (lines.length < 2) {
          setError('Le fichier doit contenir au moins une ligne d\'en-tête et une ligne de données');
          return;
        }

        const headers = lines[0].split(';');
        const dossiers = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(';');
          if (values.length !== headers.length) {
            setError(`Ligne ${i + 1}: nombre de colonnes incorrect`);
            return;
          }

          const dossier = {
            id: Date.now() + i,
            number: values[0],
            name: values[1],
            siren: values[2],
            siret: values[3],
            agency: values[4],
            responsable: values[5],
            regimeFiscal: values[6],
            activite: '',
            tva: {
              regime: values[7],
              periodicite: values[8],
              statut: 'En attente'
            },
            cfe: { statut: 'Non concerné' },
            tvs: { actif: false, vehicules: [] }
          };
          
          dossiers.push(dossier);
        }

        onSave(dossiers);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
            <div className="modal-header">
              <h2 style={{fontSize: '20px', fontWeight: 700}}>
                📂 Import en masse de dossiers
              </h2>
              <button onClick={onClose} className="btn small">✕</button>
            </div>
            
            <div className="modal-body">
              <div style={{marginBottom: '16px'}}>
                <button onClick={downloadTemplate} className="btn primary">
                  📥 Télécharger le modèle CSV
                </button>
                <p style={{fontSize: '12px', color: 'var(--muted)', marginTop: '8px'}}>
                  Téléchargez le modèle, remplissez-le avec vos données, puis collez le contenu ci-dessous
                </p>
              </div>

              <div className="form-group">
                <label className="form-label">Données CSV (séparateur: point-virgule)</label>
                <textarea
                  className="form-control"
                  value={importData}
                  onChange={(e) => setImportData(e.target.value)}
                  rows="12"
                  style={{fontFamily: 'monospace', fontSize: '12px'}}
                  placeholder="Collez ici le contenu de votre fichier CSV..."
                />
              </div>

              {error && (
                <div style={{
                  padding: '12px',
                  background: '#fee2e2',
                  border: '1px solid #ef4444',
                  borderRadius: '8px',
                  color: '#991b1b',
                  fontSize: '13px',
                  marginTop: '12px'
                }}>
                  ⚠️ {error}
                </div>
              )}
            </div>
            
            <div className="modal-footer">
              <button type="button" onClick={onClose} className="btn">
                Annuler
              </button>
              <button 
                type="button"
                onClick={handleImport}
                className="btn primary"
                disabled={!importData.trim()}
              >
                Importer les dossiers
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // ==================== IMPORT MASSE DOSSIERS ====================
    function ImportMasseDossiers({ dossiers, setDossiers, agencies, users, showToast }) {
      const [showImportModal, setShowImportModal] = useState(false);
      
      const handleImport = (newDossiers) => {
        setDossiers([...dossiers, ...newDossiers]);
        setShowImportModal(false);
        showToast(`${newDossiers.length} dossier(s) importé(s) avec succès`, 'success');
      };
      
      return (
        <div className="panel">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700 }}>📥 Import en masse de dossiers</h2>
            <button className="btn primary" onClick={() => setShowImportModal(true)}>
              ➕ Importer des dossiers
            </button>
          </div>
          
          <p style={{ marginBottom: '20px', color: 'var(--muted)' }}>
            Importez plusieurs dossiers en une seule fois à partir d'un fichier CSV.
          </p>
          
          <div style={{
            background: '#f0f9ff',
            border: '2px solid #0ea5e9',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: 700, marginBottom: '12px', color: '#0284c7' }}>
              📋 Format du fichier CSV
            </h3>
            <p style={{ fontSize: '14px', marginBottom: '12px' }}>
              Le fichier CSV doit contenir les colonnes suivantes (séparées par des point-virgules) :
            </p>
            <ul style={{ fontSize: '13px', lineHeight: '1.8', paddingLeft: '20px' }}>
              <li><strong>numero</strong> : Numéro du dossier</li>
              <li><strong>nom</strong> : Nom du client</li>
              <li><strong>siren</strong> : Numéro SIREN (9 chiffres)</li>
              <li><strong>siret</strong> : Numéro SIRET (14 chiffres)</li>
              <li><strong>agency</strong> : Code de l'agence (AG001, AG002, etc.)</li>
              <li><strong>responsable</strong> : Code du responsable (USER001, USER002, etc.)</li>
              <li><strong>regimeFiscal</strong> : Régime fiscal (IS, IR, etc.)</li>
              <li><strong>regimeTVA</strong> : Régime TVA (Réel normal, Réel simplifié, etc.)</li>
              <li><strong>periodicite</strong> : Périodicité TVA (Mensuelle, Trimestrielle, etc.)</li>
            </ul>
          </div>
          
          <div style={{ marginTop: '20px', padding: '16px', background: '#fef3c7', borderRadius: '12px' }}>
            <p style={{ fontSize: '13px', color: '#92400e' }}>
              💡 <strong>Astuce :</strong> Cliquez sur "Importer des dossiers" puis téléchargez le modèle CSV pour obtenir un exemple de fichier correctement formaté.
            </p>
          </div>
          
          {showImportModal && (
            <ImportDossiersModal
              onSave={handleImport}
              onClose={() => setShowImportModal(false)}
              agencies={agencies}
              users={users}
            />
          )}
        </div>
      );
    }
    
    // ==================== ADMIN VIEW ====================
    function AdminView({ users, setUsers, agencies, setAgencies, dossiers, setDossiers, showToast }) {
      const [activeSubTab, setActiveSubTab] = useState('users');
      
      return (
        <div style={{ paddingTop: '20px' }}>
          <h1 style={{ fontSize: '28px', fontWeight: 800, marginBottom: '20px' }}>
            ⚙️ Administration
          </h1>
          
          <div className="sub-tabs">
            <button
              className={`sub-tab ${activeSubTab === 'users' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('users')}
            >
              👥 Utilisateurs
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'agencies' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('agencies')}
            >
              🏢 Agences
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'affectation' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('affectation')}
            >
              📂 Affectation en masse
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'transfert' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('transfert')}
            >
              🔄 Transfert agences
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'revisionSimple' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('revisionSimple')}
            >
              📋 Révision Simplifiée
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'revisionAnnuelle' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('revisionAnnuelle')}
            >
              📊 Révision Annuelle
            </button>
            <button
              className={`sub-tab ${activeSubTab === 'import' ? 'active' : ''}`}
              onClick={() => setActiveSubTab('import')}
            >
              📥 Import de dossiers
            </button>
          </div>
          
          {activeSubTab === 'users' && (
            <UsersManagement users={users} setUsers={setUsers} agencies={agencies} showToast={showToast} />
          )}
          
          {activeSubTab === 'agencies' && (
            <AgenciesManagement 
              agencies={agencies} 
              setAgencies={setAgencies} 
              showToast={showToast} 
              dossiers={dossiers}
              setDossiers={setDossiers}
            />
          )}
          
          {activeSubTab === 'affectation' && (
            <AffectationMasse users={users} agencies={agencies} dossiers={dossiers} setDossiers={setDossiers} showToast={showToast} />
          )}
          
          {activeSubTab === 'transfert' && (
            <TransfertMasseDossiers 
              agencies={agencies} 
              dossiers={dossiers} 
              setDossiers={setDossiers} 
              showToast={showToast} 
            />
          )}
          
          {activeSubTab === 'archivage' && (
            <ArchivageDossiers 
              dossiers={dossiers} 
              setDossiers={setDossiers} 
              agencies={agencies}
              showToast={showToast} 
            />
          )}
          
          {activeSubTab === 'ajoutRevision' && (
            <AjoutMasseRevision 
              dossiers={dossiers} 
              setDossiers={setDossiers} 
              agencies={agencies}
              showToast={showToast}
              currentUser={currentUser}
            />
          )}
          
          {activeSubTab === 'revisionSimple' && (
            <RevisionSimpleAdmin showToast={showToast} />
          )}
          
          {activeSubTab === 'revisionAnnuelle' && (
            <RevisionAnnuelleAdmin showToast={showToast} />
          )}
          
          {activeSubTab === 'import' && (
            <ImportMasseDossiers dossiers={dossiers} setDossiers={setDossiers} agencies={agencies} users={users} showToast={showToast} />
          )}
        </div>
      );
    }
    
    // ==================== RÉVISION SIMPLIFIÉE VIEW ====================
    function RevisionSimplifieeView({ dossiers, onEdit, agencies, currentUser, saveDossier }) {
      const [selectedDossier, setSelectedDossier] = useState(null);
      const [showCycles, setShowCycles] = useState(false);
      
      // Filtrer les dossiers en révision simplifiée (IR ou Réel simplifié)
      const revisionDossiers = dossiers.filter(d => 
        d.regimeFiscal === 'IR' || d.tva.regime === 'Réel simplifié'
      );
      
      // Initialiser les cycles si pas présents
      React.useEffect(() => {
        revisionDossiers.forEach(d => {
          if (!d.revision_simple) {
            d.revision_simple = {
              actif: true,
              euroAttache: 0,
              cycles: JSON.parse(JSON.stringify(getConfiguredCyclesSimple()))
            };
            saveDossier(d);
          }
        });
      }, []);
      
      const currentDossier = selectedDossier || revisionDossiers[0];
      
      const updateDiligence = (cycleIndex, diligenceIndex, field, value) => {
        const updatedCycles = [...currentDossier.revision_simple.cycles];
        updatedCycles[cycleIndex].diligences[diligenceIndex][field] = value;
        
        if (['oui', 'non', 'na'].includes(field)) {
          const now = new Date();
          updatedCycles[cycleIndex].diligences[diligenceIndex].dateModif = now.toLocaleDateString('fr-FR') + ' ' + now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
          updatedCycles[cycleIndex].diligences[diligenceIndex].controleur = currentUser.prenom + ' ' + currentUser.nom;
        }
        
        if (field === 'oui' && value) {
          updatedCycles[cycleIndex].diligences[diligenceIndex].non = false;
          updatedCycles[cycleIndex].diligences[diligenceIndex].na = false;
        } else if (field === 'non' && value) {
          updatedCycles[cycleIndex].diligences[diligenceIndex].oui = false;
          updatedCycles[cycleIndex].diligences[diligenceIndex].na = false;
        } else if (field === 'na' && value) {
          updatedCycles[cycleIndex].diligences[diligenceIndex].oui = false;
          updatedCycles[cycleIndex].diligences[diligenceIndex].non = false;
        }
        
        const updatedDossier = {...currentDossier, revision_simple: {...currentDossier.revision_simple, cycles: updatedCycles}};
        saveDossier(updatedDossier);
        setSelectedDossier(updatedDossier);
      };
      
      const getCycleProgress = (cycle) => {
        const total = cycle.diligences.length;
        if (total === 0) return 0;
        
        let reponses = 0;
        cycle.diligences.forEach(d => {
          if (d.oui || d.non || d.na) reponses++;
        });
        
        return Math.round((reponses / total) * 100);
      };
      
      const getGlobalProgress = () => {
        if (!currentDossier?.revision_simple) return 0;
        let totalDiligences = 0;
        let reponsesDonnees = 0;
        
        currentDossier.revision_simple.cycles.forEach(cycle => {
          cycle.diligences.forEach(diligence => {
            totalDiligences++;
            if (diligence.oui || diligence.non || diligence.na) {
              reponsesDonnees++;
            }
          });
        });
        
        return totalDiligences > 0 ? Math.round((reponsesDonnees / totalDiligences) * 100) : 0;
      };
      
      if (!currentDossier) {
        return (
          <div style={{paddingTop: '20px'}}>
            <h1 style={{fontSize: '28px', fontWeight: 800, marginBottom: '20px'}}>
              📋 Révision Simplifiée
            </h1>
            <div className="panel">
              <p className="muted">Aucun dossier en révision simplifiée</p>
            </div>
          </div>
        );
      }
      
      return (
        <div style={{paddingTop: '20px'}}>
          <h1 style={{fontSize: '28px', fontWeight: 800, marginBottom: '12px'}}>
            📋 Révision Simplifiée
          </h1>
          {currentDossier && (
            <div style={{marginBottom: '20px', padding: '12px', background: '#f0f4ff', borderRadius: '8px', border: '1px solid #dbeafe'}}>
              <span style={{fontSize: '14px', fontWeight: 600, color: '#1e40af'}}>
                📁 {currentDossier.number} - {currentDossier.name} | 
                👨‍💼 Responsable: <strong>{currentDossier.responsable || 'Non attribué'}</strong>
              </span>
            </div>
          )}
          
          {!showCycles ? (
            <div className="panel">
              <h3 className="section-title">📊 Dossiers en révision simplifiée</h3>
              <table>
                <thead>
                  <tr>
                    <th>N° Dossier</th>
                    <th>Nom</th>
                    <th>Régime</th>
                    {getConfiguredCyclesSimple().map((cycle, idx) => (
                      <th key={idx} style={{textAlign: 'center'}}>{cycle.name}</th>
                    ))}
                    <th style={{textAlign: 'center'}}>Global</th>
                  </tr>
                </thead>
                <tbody>
                  {revisionDossiers.map(d => {
                    if (!d.revision_simple) return null;
                    return (
                      <tr key={d.id} style={{cursor: 'pointer'}} onClick={() => {setSelectedDossier(d); setShowCycles(true);}}>
                        <td style={{fontWeight: 600}}>{d.number}</td>
                        <td>{d.name}</td>
                        <td>
                          <span className="badge">{d.tva.regime}</span>
                        </td>
                        {d.revision_simple.cycles.map((cycle, idx) => {
                          const progress = getCycleProgress(cycle);
                          const getProgressColor = (prog) => {
                            if (prog >= 67) return '#22c55e'; // Vert
                            if (prog >= 34) return '#3b82f6'; // Bleu
                            return '#ef4444'; // Rouge
                          };
                          return (
                            <td key={idx} style={{textAlign: 'center'}}>
                              <div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}}>
                                <div className="progress" style={{width: '60px'}}>
                                  <i style={{width: `${progress}%`, background: getProgressColor(progress)}}></i>
                                </div>
                                <span style={{fontSize: '11px', fontWeight: 600, color: getProgressColor(progress)}}>{progress}%</span>
                              </div>
                            </td>
                          );
                        })}
                        <td style={{textAlign: 'center'}}>
                          <span style={{fontSize: '12px', fontWeight: 700}}>{getGlobalProgress()}%</span>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          ) : (
            <>
              <div className="panel" style={{marginBottom: '16px'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px'}}>
                  <button className="btn" onClick={() => setShowCycles(false)}>
                    ← Retour au tableau
                  </button>
                  <select 
                    value={currentDossier.id} 
                    onChange={(e) => setSelectedDossier(revisionDossiers.find(d => d.id === parseInt(e.target.value)))}
                    style={{flex: 1, maxWidth: '400px'}}
                  >
                    {revisionDossiers.map(d => (
                      <option key={d.id} value={d.id}>{d.number} - {d.name}</option>
                    ))}
                  </select>
                  <span style={{fontSize: '13px', fontWeight: 600}}>Progrès global :</span>
                  <div className="progress" style={{width: '120px'}}>
                    <i style={{width: `${getGlobalProgress()}%`}}></i>
                  </div>
                  <span style={{fontSize: '13px', fontWeight: 700}}>{getGlobalProgress()}%</span>
                </div>
              </div>
              
              {currentDossier.revision_simple.cycles.map((cycle, cycleIndex) => {
                const progress = getCycleProgress(cycle);
                // Couleurs pour chaque cycle
                const cycleColors = [
                  { bg: '#f0f9ff', border: '#0ea5e9', header: '#0284c7' }, // Bleu clair
                  { bg: '#fef3c7', border: '#f59e0b', header: '#d97706' }, // Jaune/Orange
                  { bg: '#dcfce7', border: '#22c55e', header: '#16a34a' }, // Vert
                  { bg: '#fce7f3', border: '#ec4899', header: '#db2777' }, // Rose
                  { bg: '#f3e8ff', border: '#a855f7', header: '#9333ea' }, // Violet
                ];
                const colors = cycleColors[cycleIndex % cycleColors.length];
                
                return (
                  <div key={cycleIndex} style={{
                    background: colors.bg,
                    border: `2px solid ${colors.border}`,
                    borderRadius: '12px',
                    padding: '20px',
                    marginBottom: '16px'
                  }}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                      <h3 style={{fontSize: '16px', fontWeight: 700, color: colors.header}}>{cycle.name}</h3>
                      <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                        <div className="progress" style={{width: '120px'}}>
                          <i style={{width: `${progress}%`}}></i>
                        </div>
                        <span style={{fontSize: '13px', fontWeight: 700}}>{progress}%</span>
                      </div>
                    </div>
                    
                    <div>
                      {/* En-tête OUI/NON/N/A */}
                      <div style={{
                        display: 'flex',
                        gap: '12px',
                        padding: '8px 10px',
                        background: '#f7f8fb',
                        borderBottom: '2px solid var(--line)',
                        fontWeight: 700,
                        fontSize: '12px'
                      }}>
                        <div style={{flex: '0 0 40%'}}>
                          Diligence
                        </div>
                        <div style={{display: 'flex', gap: '8px', minWidth: '160px', justifyContent: 'center'}}>
                          <span style={{color: '#14b37d', minWidth: '42px', textAlign: 'center'}}>OUI</span>
                          <span style={{color: '#e24d4d', minWidth: '42px', textAlign: 'center'}}>NON</span>
                          <span style={{color: '#a7b0c2', minWidth: '42px', textAlign: 'center'}}>N/A</span>
                        </div>
                        <div style={{minWidth: '200px', textAlign: 'center'}}>
                          Contrôleur / Date
                        </div>
                        <div style={{width: '180px', textAlign: 'center'}}>
                          Observations
                        </div>
                      </div>
                      
                      {cycle.diligences.map((diligence, diligenceIndex) => (
                        <div key={diligenceIndex} style={{
                          display: 'flex',
                          gap: '12px',
                          padding: '4px 10px',
                          borderBottom: '1px solid var(--line)',
                          alignItems: 'center'
                        }}>
                          <div style={{flex: '0 0 40%', fontSize: '13px', color: 'var(--text)'}}>
                            {diligence.description}
                          </div>
                          
                          <div style={{display: 'flex', gap: '8px', minWidth: '160px', justifyContent: 'center'}}>
                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', minWidth: '42px'}}>
                              <input 
                                type="radio" 
                                checked={diligence.oui}
                                onChange={() => updateDiligence(cycleIndex, diligenceIndex, 'oui', true)}
                              />
                            </label>
                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', minWidth: '42px'}}>
                              <input 
                                type="radio" 
                                checked={diligence.non}
                                onChange={() => updateDiligence(cycleIndex, diligenceIndex, 'non', true)}
                              />
                            </label>
                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', minWidth: '42px'}}>
                              <input 
                                type="radio" 
                                checked={diligence.na}
                                onChange={() => updateDiligence(cycleIndex, diligenceIndex, 'na', true)}
                              />
                            </label>
                          </div>
                          
                          <div style={{minWidth: '200px'}}>
                            <div style={{
                              fontSize: '10px', 
                              padding: '4px 8px', 
                              background: '#f7f8fb', 
                              color: 'var(--text)', 
                              border: '1px solid var(--line)', 
                              borderRadius: '6px',
                              fontWeight: 500,
                              lineHeight: '1.3'
                            }}>
                              {diligence.controleur ? (
                                <span style={{display: 'inline'}}><strong>{diligence.controleur}</strong> • {diligence.dateModif}</span>
                              ) : (
                                <span style={{color: 'var(--muted)'}}>Non renseigné</span>
                              )}
                            </div>
                          </div>
                          
                          <input 
                            type="text" 
                            placeholder="Observations..." 
                            value={diligence.observations || ""}
                            onChange={(e) => updateDiligence(cycleIndex, diligenceIndex, 'observations', e.target.value)}
                            style={{width: '180px', fontSize: '12px', padding: '8px', border: '1px solid var(--line)', borderRadius: '6px'}}
                          />
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </>
          )}
        </div>
      );
    }
    
    // ==================== RÉVISION ANNUELLE VIEW ====================
    function RevisionAnnuelleMainView({ dossiers, onEdit, agencies, currentUser, saveDossier }) {
      const [selectedDossier, setSelectedDossier] = useState(null);
      const [showCycles, setShowCycles] = useState(false);
      
      // Filtrer les dossiers en révision annuelle (IS)
      const revisionDossiers = dossiers.filter(d => d.regimeFiscal === 'IS').map(d => {
        // Initialiser les cycles si pas présents
        if (!d.revision_annuelle) {
          return {
            ...d,
            revision_annuelle: {
              actif: true,
              euroAttache: 0,
              cycles: JSON.parse(JSON.stringify(getConfiguredCyclesAnnuelle()))
            }
          };
        }
        return d;
      });
      
      const currentDossier = selectedDossier || revisionDossiers[0];
      
      const updateDiligence = (cycleIndex, diligenceIndex, field, value) => {
        if (!currentDossier?.revision_annuelle?.cycles) return;
        
        const updatedCycles = [...currentDossier.revision_annuelle.cycles];
        updatedCycles[cycleIndex].diligences[diligenceIndex][field] = value;
        
        if (['oui', 'non', 'na'].includes(field)) {
          const now = new Date();
          updatedCycles[cycleIndex].diligences[diligenceIndex].dateModif = now.toLocaleDateString('fr-FR') + ' ' + now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
          updatedCycles[cycleIndex].diligences[diligenceIndex].controleur = currentUser.prenom + ' ' + currentUser.nom;
        }
        
        if (field === 'oui' && value) {
          updatedCycles[cycleIndex].diligences[diligenceIndex].non = false;
          updatedCycles[cycleIndex].diligences[diligenceIndex].na = false;
        } else if (field === 'non' && value) {
          updatedCycles[cycleIndex].diligences[diligenceIndex].oui = false;
          updatedCycles[cycleIndex].diligences[diligenceIndex].na = false;
        } else if (field === 'na' && value) {
          updatedCycles[cycleIndex].diligences[diligenceIndex].oui = false;
          updatedCycles[cycleIndex].diligences[diligenceIndex].non = false;
        }
        
        const updatedDossier = {...currentDossier, revision_annuelle: {...currentDossier.revision_annuelle, cycles: updatedCycles}};
        saveDossier(updatedDossier);
        setSelectedDossier(updatedDossier);
      };
      
      const getCycleProgress = (cycle) => {
        const total = cycle.diligences.length;
        if (total === 0) return 0;
        
        let reponses = 0;
        cycle.diligences.forEach(d => {
          if (d.oui || d.non || d.na) reponses++;
        });
        
        return Math.round((reponses / total) * 100);
      };
      
      const getGlobalProgress = () => {
        if (!currentDossier?.revision_annuelle) return 0;
        let totalDiligences = 0;
        let reponsesDonnees = 0;
        
        currentDossier.revision_annuelle.cycles.forEach(cycle => {
          cycle.diligences.forEach(diligence => {
            totalDiligences++;
            if (diligence.oui || diligence.non || diligence.na) {
              reponsesDonnees++;
            }
          });
        });
        
        return totalDiligences > 0 ? Math.round((reponsesDonnees / totalDiligences) * 100) : 0;
      };
      
      const handleSaveEuroAttache = () => {
        saveDossier(currentDossier);
      };
      
      if (!currentDossier) {
        return (
          <div style={{paddingTop: '20px'}}>
            <h1 style={{fontSize: '28px', fontWeight: 800, marginBottom: '20px'}}>
              📊 Révision Annuelle
            </h1>
            <div className="panel">
              <p className="muted">Aucun dossier en révision annuelle</p>
            </div>
          </div>
        );
      }
      
      return (
        <div style={{paddingTop: '20px'}}>
          <h1 style={{fontSize: '28px', fontWeight: 800, marginBottom: '12px'}}>
            📊 Révision Annuelle - Bilan
          </h1>
          {currentDossier && (
            <div style={{marginBottom: '20px', padding: '12px', background: '#f0f4ff', borderRadius: '8px', border: '1px solid #dbeafe'}}>
              <span style={{fontSize: '14px', fontWeight: 600, color: '#1e40af'}}>
                📁 {currentDossier.number} - {currentDossier.name} | 
                👨‍💼 Responsable: <strong>{currentDossier.responsable || 'Non attribué'}</strong>
              </span>
            </div>
          )}
          
          {!showCycles ? (
            <div className="panel">
              <h3 className="section-title">📊 Tableau de bord des cycles</h3>
              <p className="subtle" style={{marginBottom: '12px'}}>Cliquez sur un dossier pour voir les cycles détaillés</p>
              
              <div style={{overflow: 'auto'}}>
                <table>
                  <thead>
                    <tr>
                      <th>N° Dossier</th>
                      <th>Nom</th>
                      {currentDossier.revision_annuelle.cycles.map((cycle, idx) => (
                        <th key={idx} style={{textAlign: 'center', fontSize: '11px'}}>{cycle.name}</th>
                      ))}
                      <th style={{textAlign: 'center'}}>Global</th>
                    </tr>
                  </thead>
                  <tbody>
                    {revisionDossiers.map(d => {
                      if (!d.revision_annuelle) return null;
                      return (
                        <tr 
                          key={d.id} 
                          style={{cursor: 'pointer'}} 
                          onClick={() => {setSelectedDossier(d); setShowCycles(true);}}
                        >
                          <td style={{fontWeight: 600}}>{d.number}</td>
                          <td>{d.name}</td>
                          {d.revision_annuelle.cycles.map((cycle, idx) => {
                            const progress = getCycleProgress(cycle);
                            const getProgressColor = (prog) => {
                              if (prog >= 67) return '#22c55e'; // Vert
                              if (prog >= 34) return '#3b82f6'; // Bleu
                              return '#ef4444'; // Rouge
                            };
                            return (
                              <td key={idx} style={{textAlign: 'center'}}>
                                <div style={{display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}}>
                                  <div className="progress" style={{width: '60px'}}>
                                    <i style={{width: `${progress}%`, background: getProgressColor(progress)}}></i>
                                  </div>
                                  <span style={{fontSize: '11px', fontWeight: 600, color: getProgressColor(progress)}}>{progress}%</span>
                                </div>
                              </td>
                            );
                          })}
                          <td style={{textAlign: 'center'}}>
                            <span style={{fontSize: '12px', fontWeight: 700}}>{getGlobalProgress()}%</span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          ) : (
            <>
              <div className="panel" style={{marginBottom: '16px'}}>
                <div className="row">
                  <button className="btn" onClick={() => setShowCycles(false)}>
                    ← Retour au tableau de bord
                  </button>
                  
                  <select 
                    value={currentDossier.id} 
                    onChange={(e) => setSelectedDossier(revisionDossiers.find(d => d.id === parseInt(e.target.value)))}
                    style={{flex: 1, maxWidth: '400px', padding: '10px', borderRadius: '8px', border: '1px solid var(--line)'}}
                  >
                    {revisionDossiers.map(d => (
                      <option key={d.id} value={d.id}>{d.number} - {d.name}</option>
                    ))}
                  </select>
                </div>
                
                <div className="row" style={{marginTop: '12px'}}>
                  <span className="subtle">
                    N° {currentDossier.number} • {currentDossier.tva?.periodicite} • Jour {currentDossier.tva?.jour}
                  </span>
                  <div className="spacer"></div>
                  <span style={{fontSize: '13px', fontWeight: 600}}>Progrès global :</span>
                  <div className="progress" style={{width: '120px'}}>
                    <i style={{width: `${getGlobalProgress()}%`}}></i>
                  </div>
                  <span style={{fontSize: '13px', fontWeight: 700}}>{getGlobalProgress()}%</span>
                </div>
              </div>
              
              {currentDossier.revision_annuelle.cycles.map((cycle, cycleIndex) => {
                const progress = getCycleProgress(cycle);
                // Couleurs pour chaque cycle
                const cycleColors = [
                  { bg: '#f0f9ff', border: '#0ea5e9', header: '#0284c7' }, // Bleu clair
                  { bg: '#fef3c7', border: '#f59e0b', header: '#d97706' }, // Jaune/Orange
                  { bg: '#dcfce7', border: '#22c55e', header: '#16a34a' }, // Vert
                  { bg: '#fce7f3', border: '#ec4899', header: '#db2777' }, // Rose
                  { bg: '#f3e8ff', border: '#a855f7', header: '#9333ea' }, // Violet
                ];
                const colors = cycleColors[cycleIndex % cycleColors.length];
                
                return (
                  <div key={cycleIndex} style={{
                    background: colors.bg,
                    border: `2px solid ${colors.border}`,
                    borderRadius: '12px',
                    padding: '20px',
                    marginBottom: '16px'
                  }}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px', paddingBottom: '12px', borderBottom: `2px solid ${colors.border}`}}>
                      <h3 style={{fontSize: '16px', fontWeight: 700, color: colors.header}}>{cycle.name}</h3>
                      <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                        <div className="progress" style={{width: '120px'}}>
                          <i style={{width: `${progress}%`}}></i>
                        </div>
                        <span style={{fontSize: '13px', fontWeight: 700}}>{progress}%</span>
                      </div>
                    </div>
                    
                    <div>
                      {/* En-tête OUI/NON/N/A */}
                      <div style={{
                        display: 'flex',
                        gap: '12px',
                        padding: '8px 10px',
                        background: '#f7f8fb',
                        borderBottom: '2px solid var(--line)',
                        fontWeight: 700,
                        fontSize: '12px'
                      }}>
                        <div style={{flex: '0 0 40%'}}>
                          Diligence
                        </div>
                        <div style={{display: 'flex', gap: '8px', minWidth: '160px', justifyContent: 'center'}}>
                          <span style={{color: '#14b37d', minWidth: '42px', textAlign: 'center'}}>OUI</span>
                          <span style={{color: '#e24d4d', minWidth: '42px', textAlign: 'center'}}>NON</span>
                          <span style={{color: '#a7b0c2', minWidth: '42px', textAlign: 'center'}}>N/A</span>
                        </div>
                        <div style={{minWidth: '200px', textAlign: 'center'}}>
                          Contrôleur / Date
                        </div>
                        <div style={{width: '180px', textAlign: 'center'}}>
                          Observations
                        </div>
                      </div>
                      
                      {cycle.diligences.map((diligence, diligenceIndex) => (
                        <div key={diligenceIndex} style={{
                          display: 'flex',
                          gap: '12px',
                          padding: '4px 10px',
                          borderBottom: '1px solid var(--line)',
                          alignItems: 'center'
                        }}>
                          <div style={{flex: '0 0 40%', fontSize: '13px', color: 'var(--text)'}}>
                            {diligence.description}
                          </div>
                          
                          <div style={{display: 'flex', gap: '8px', minWidth: '160px', justifyContent: 'center'}}>
                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', minWidth: '42px'}}>
                              <input 
                                type="radio" 
                                checked={diligence.oui}
                                onChange={() => updateDiligence(cycleIndex, diligenceIndex, 'oui', true)}
                              />
                            </label>
                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', minWidth: '42px'}}>
                              <input 
                                type="radio" 
                                checked={diligence.non}
                                onChange={() => updateDiligence(cycleIndex, diligenceIndex, 'non', true)}
                              />
                            </label>
                            <label style={{display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', minWidth: '42px'}}>
                              <input 
                                type="radio" 
                                checked={diligence.na}
                                onChange={() => updateDiligence(cycleIndex, diligenceIndex, 'na', true)}
                              />
                            </label>
                          </div>
                          
                          <div style={{minWidth: '200px'}}>
                            <div style={{
                              fontSize: '10px', 
                              padding: '4px 8px', 
                              background: '#f7f8fb', 
                              color: 'var(--text)', 
                              border: '1px solid var(--line)', 
                              borderRadius: '6px',
                              fontWeight: 500,
                              lineHeight: '1.3'
                            }}>
                              {diligence.controleur ? (
                                <span style={{display: 'inline'}}><strong>{diligence.controleur}</strong> • {diligence.dateModif}</span>
                              ) : (
                                <span style={{color: 'var(--muted)'}}>Non renseigné</span>
                              )}
                            </div>
                          </div>
                          
                          <input 
                            type="text" 
                            placeholder="Observations..." 
                            value={diligence.observations || ""}
                            onChange={(e) => updateDiligence(cycleIndex, diligenceIndex, 'observations', e.target.value)}
                            style={{width: '180px', fontSize: '12px', padding: '8px', border: '1px solid var(--line)', borderRadius: '6px'}}
                          />
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </>
          )}
        </div>
      );
    }
    
    // ==================== USERS MANAGEMENT ====================
    function UsersManagement({ users, setUsers, agencies, showToast }) {
      const [searchQuery, setSearchQuery] = useState('');
      const [roleFilter, setRoleFilter] = useState('all');
      const [editingUser, setEditingUser] = useState(null);
      const [showModal, setShowModal] = useState(false);
      
      const filteredUsers = users.filter(u => {
        if (roleFilter !== 'all' && u.role !== roleFilter) return false;
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          return u.prenom.toLowerCase().includes(q) ||
                 u.nom.toLowerCase().includes(q) ||
                 u.email.toLowerCase().includes(q);
        }
        return true;
      });
      
      const handleEdit = (user) => {
        setEditingUser({...user});
        setShowModal(true);
      };
      
      const handleSave = () => {
        setUsers(users.map(u => u.id === editingUser.id ? editingUser : u));
        setShowModal(false);
        setEditingUser(null);
        showToast('Utilisateur modifié avec succès', 'success');
      };
      
      const toggleAgence = (agenceId) => {
        if (agenceId === 'tous') {
          setEditingUser({...editingUser, agences: ['tous']});
        } else {
          const agences = editingUser.agences.includes('tous') 
            ? [agenceId] 
            : editingUser.agences.includes(agenceId)
              ? editingUser.agences.filter(a => a !== agenceId)
              : [...editingUser.agences, agenceId];
          setEditingUser({...editingUser, agences: agences.length > 0 ? agences : ['tous']});
        }
      };
      
      return (
        <>
          <div className="panel">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2 style={{ fontSize: '20px', fontWeight: 700 }}>👥 Gestion des utilisateurs ({users.length})</h2>
              <button className="btn primary">➕ Nouvel utilisateur</button>
            </div>
            
            <div className="toolbar">
              <div className="search">
                <span>🔍</span>
                <input
                  type="text"
                  placeholder="Rechercher par nom, prénom, email..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>
              
              <select
                className="btn"
                value={roleFilter}
                onChange={(e) => setRoleFilter(e.target.value)}
              >
                <option value="all">Tous les rôles</option>
                <option value="Admin">Admin</option>
                <option value="Chef d'agence">Chef d'agence</option>
                <option value="Comptable">Comptable</option>
              </select>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>Nom Prénom</th>
                  <th>Email</th>
                  <th>Rôle</th>
                  <th>Agence(s)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredUsers.map(u => (
                  <tr key={u.id}>
                    <td><strong>{u.prenom} {u.nom}</strong></td>
                    <td style={{ fontSize: '13px', color: 'var(--muted)' }}>{u.email}</td>
                    <td>
                      <span className="badge" style={{
                        background: u.role === 'Admin' ? '#fce7f3' : u.role === 'Chef d\'agence' ? '#dbeafe' : '#f3f4f6',
                        color: u.role === 'Admin' ? '#9f1239' : u.role === 'Chef d\'agence' ? '#1e40af' : '#4b5563',
                        borderColor: u.role === 'Admin' ? '#f9a8d4' : u.role === 'Chef d\'agence' ? '#93c5fd' : '#d1d5db'
                      }}>
                        {u.role}
                      </span>
                    </td>
                    <td>
                      <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                        {u.agences.slice(0, 2).map(agId => {
                          const ag = agencies.find(a => a.id === agId);
                          return ag ? (
                            <span key={agId} className="pill" style={{ 
                              background: ag.color + '15', 
                              color: ag.color, 
                              borderColor: ag.color,
                              fontSize: '10px',
                              padding: '3px 8px'
                            }}>
                              {ag.name}
                            </span>
                          ) : null;
                        })}
                        {u.agences.length > 2 && (
                          <span className="pill" style={{ fontSize: '10px', padding: '3px 8px' }}>
                            +{u.agences.length - 2}
                          </span>
                        )}
                      </div>
                    </td>
                    <td>
                      <button className="btn small" onClick={() => handleEdit(u)}>✏️ Modifier</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          
          {showModal && editingUser && (
            <div className="modal-overlay" onClick={() => setShowModal(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2 style={{fontSize: '20px', fontWeight: 700}}>
                    ✏️ Modifier l'utilisateur
                  </h2>
                  <button onClick={() => setShowModal(false)} className="btn small">✕</button>
                </div>
                
                <div className="modal-body">
                  <div className="form-group">
                    <label className="form-label">Nom</label>
                    <input
                      type="text"
                      className="form-control"
                      value={editingUser.nom}
                      onChange={(e) => setEditingUser({...editingUser, nom: e.target.value})}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Prénom</label>
                    <input
                      type="text"
                      className="form-control"
                      value={editingUser.prenom}
                      onChange={(e) => setEditingUser({...editingUser, prenom: e.target.value})}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Email</label>
                    <input
                      type="email"
                      className="form-control"
                      value={editingUser.email}
                      onChange={(e) => setEditingUser({...editingUser, email: e.target.value})}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Rôle *</label>
                    <select
                      className="form-control"
                      value={editingUser.role}
                      onChange={(e) => setEditingUser({...editingUser, role: e.target.value})}
                    >
                      <option value="Admin">Admin</option>
                      <option value="Chef d'agence">Chef d'agence</option>
                      <option value="Comptable">Comptable</option>
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Agences *</label>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '8px', marginTop: '8px'}}>
                      {agencies.map(agency => (
                        <label key={agency.id} style={{
                          display: 'flex', 
                          alignItems: 'center', 
                          gap: '8px', 
                          padding: '10px',
                          border: '2px solid var(--line)',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          background: editingUser.agences.includes(agency.id) ? agency.color + '10' : 'transparent',
                          borderColor: editingUser.agences.includes(agency.id) ? agency.color : 'var(--line)'
                        }}>
                          <input
                            type="checkbox"
                            checked={editingUser.agences.includes(agency.id)}
                            onChange={() => toggleAgence(agency.id)}
                            style={{width: '18px', height: '18px'}}
                          />
                          <span style={{
                            fontWeight: 600,
                            color: editingUser.agences.includes(agency.id) ? agency.color : 'var(--text)'
                          }}>
                            {agency.name}
                          </span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>
                
                <div className="modal-footer">
                  <button className="btn" onClick={() => setShowModal(false)}>Annuler</button>
                  <button className="btn primary" onClick={handleSave}>💾 Enregistrer</button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }
    
    // ==================== AGENCIES MANAGEMENT ====================
    function AgenciesManagement({ agencies, setAgencies, showToast, dossiers, setDossiers }) {
      const handleDeleteAgency = (agency) => {
        // Compter les dossiers de cette agence
        const dossiersCount = dossiers.filter(d => d.agence === agency.id).length;
        
        if (dossiersCount > 0) {
          if (!confirm(`⚠️ ATTENTION : Cette agence contient ${dossiersCount} dossier(s).\n\nSi vous supprimez cette agence, tous les dossiers associés seront également supprimés.\n\nÊtes-vous sûr de vouloir continuer ?`)) {
            return;
          }
        } else {
          if (!confirm(`Voulez-vous vraiment supprimer l'agence "${agency.name}" ?`)) {
            return;
          }
        }
        
        // Supprimer l'agence
        const newAgencies = agencies.filter(a => a.id !== agency.id);
        setAgencies(newAgencies);
        
        // Supprimer tous les dossiers de cette agence
        const newDossiers = dossiers.filter(d => d.agence !== agency.id);
        setDossiers(newDossiers);
        
        showToast(`Agence "${agency.name}" supprimée avec succès ${dossiersCount > 0 ? `(${dossiersCount} dossier(s) supprimé(s))` : ''}`, 'success');
      };
      
      return (
        <div className="panel">
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700 }}>🏢 Gestion des agences ({agencies.filter(a => a.id !== 'tous').length})</h2>
            <button className="btn primary">➕ Nouvelle agence</button>
          </div>
          
          <div className="grid-3">
            {agencies.filter(a => a.id !== 'tous').map(agency => {
              const dossiersCount = dossiers.filter(d => d.agence === agency.id).length;
              
              return (
                <div key={agency.id} style={{ 
                  padding: '24px', 
                  border: '2px solid ' + agency.color + '40', 
                  borderRadius: '12px',
                  background: agency.color + '08'
                }}>
                  <div style={{ 
                    width: '48px', 
                    height: '48px', 
                    borderRadius: '12px', 
                    background: agency.color,
                    marginBottom: '16px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '24px'
                  }}>
                    🏢
                  </div>
                  <div style={{ fontWeight: 700, fontSize: '18px', marginBottom: '8px' }}>
                    {agency.name}
                  </div>
                  <div style={{ fontSize: '12px', color: 'var(--muted)', marginBottom: '8px' }}>
                    ID: {agency.id}
                  </div>
                  <div style={{ fontSize: '13px', color: 'var(--text)', marginBottom: '16px', fontWeight: 600 }}>
                    📁 {dossiersCount} dossier{dossiersCount > 1 ? 's' : ''}
                  </div>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <button className="btn small">✏️ Modifier</button>
                    <button 
                      className="btn small danger" 
                      onClick={() => handleDeleteAgency(agency)}
                      title="Supprimer cette agence"
                    >
                      🗑️ Supprimer
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }
    

    // ==================== TRANSFERT MASSE DOSSIERS ====================
    function TransfertMasseDossiers({ agencies, dossiers, setDossiers, showToast }) {
      const [agenceSource, setAgenceSource] = useState('');
      const [agenceDestination, setAgenceDestination] = useState('');
      const [selectedDossiers, setSelectedDossiers] = useState([]);
      const [selectAll, setSelectAll] = useState(false);
      
      // Filtrer les dossiers de l'agence source
      const dossiersSource = agenceSource ? dossiers.filter(d => d.agence === agenceSource) : [];
      
      // Gérer la sélection/désélection de tous les dossiers
      const handleSelectAll = (checked) => {
        setSelectAll(checked);
        if (checked) {
          setSelectedDossiers(dossiersSource.map(d => d.id));
        } else {
          setSelectedDossiers([]);
        }
      };
      
      // Gérer la sélection d'un dossier individuel
      const handleSelectDossier = (dossierId) => {
        if (selectedDossiers.includes(dossierId)) {
          setSelectedDossiers(selectedDossiers.filter(id => id !== dossierId));
        } else {
          setSelectedDossiers([...selectedDossiers, dossierId]);
        }
      };
      
      // Transférer les dossiers sélectionnés
      const handleTransfert = () => {
        if (!agenceSource || !agenceDestination) {
          showToast('Veuillez sélectionner une agence source et une agence destination', 'error');
          return;
        }
        
        if (agenceSource === agenceDestination) {
          showToast('L\'agence source et destination doivent être différentes', 'error');
          return;
        }
        
        if (selectedDossiers.length === 0) {
          showToast('Veuillez sélectionner au moins un dossier à transférer', 'error');
          return;
        }
        
        const agenceSourceName = agencies.find(a => a.id === agenceSource)?.name || agenceSource;
        const agenceDestName = agencies.find(a => a.id === agenceDestination)?.name || agenceDestination;
        
        if (!confirm(`⚠️ CONFIRMATION DE TRANSFERT

${selectedDossiers.length} dossier(s) seront transférés
DE: ${agenceSourceName}
VERS: ${agenceDestName}

Cette action est irréversible.
Confirmez-vous le transfert ?`)) {
          return;
        }
        
        // Effectuer le transfert
        const newDossiers = dossiers.map(d => {
          if (selectedDossiers.includes(d.id)) {
            return { ...d, agence: agenceDestination };
          }
          return d;
        });
        
        setDossiers(newDossiers);
        showToast(`${selectedDossiers.length} dossier(s) transféré(s) avec succès de "${agenceSourceName}" vers "${agenceDestName}"`, 'success');
        
        // Réinitialiser
        setSelectedDossiers([]);
        setSelectAll(false);
      };
      
      return (
        <div className="panel">
          <div style={{ marginBottom: '24px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '8px' }}>🔄 Transfert en masse de dossiers</h2>
            <p style={{ color: 'var(--muted)', fontSize: '14px' }}>
              Transférer plusieurs dossiers d\'une agence vers une autre agence
            </p>
          </div>
          
          {/* Alerte d\'avertissement */}
          <div style={{ 
            padding: '16px', 
            background: '#fef3c7', 
            border: '2px solid #f59e0b', 
            borderRadius: '12px', 
            marginBottom: '24px',
            display: 'flex',
            gap: '12px'
          }}>
            <span style={{ fontSize: '20px' }}>⚠️</span>
            <div>
              <div style={{ fontWeight: 700, marginBottom: '4px', color: '#92400e' }}>
                Attention : Action irréversible
              </div>
              <div style={{ fontSize: '13px', color: '#78350f' }}>
                Le transfert de dossiers est une opération définitive. Assurez-vous de bien vérifier l\'agence source et destination avant de valider.
              </div>
            </div>
          </div>
          
          {/* Sélection des agences */}
          <div className="grid-2" style={{ marginBottom: '24px', gap: '24px' }}>
            <div>
              <label className="form-label" style={{ fontWeight: 600, marginBottom: '12px', display: 'block' }}>
                🏢 Agence source
              </label>
              <select 
                className="form-control" 
                value={agenceSource}
                onChange={(e) => {
                  setAgenceSource(e.target.value);
                  setSelectedDossiers([]);
                  setSelectAll(false);
                }}
              >
                <option value="">Sélectionner une agence source</option>
                {agencies.filter(a => a.id !== 'tous').map(agency => {
                  const count = dossiers.filter(d => d.agence === agency.id).length;
                  return (
                    <option key={agency.id} value={agency.id}>
                      {agency.name} ({count} dossier{count > 1 ? 's' : ''})
                    </option>
                  );
                })}
              </select>
            </div>
            
            <div>
              <label className="form-label" style={{ fontWeight: 600, marginBottom: '12px', display: 'block' }}>
                🎯 Agence destination
              </label>
              <select 
                className="form-control" 
                value={agenceDestination}
                onChange={(e) => setAgenceDestination(e.target.value)}
              >
                <option value="">Sélectionner une agence destination</option>
                {agencies.filter(a => a.id !== 'tous' && a.id !== agenceSource).map(agency => {
                  const count = dossiers.filter(d => d.agence === agency.id).length;
                  return (
                    <option key={agency.id} value={agency.id}>
                      {agency.name} ({count} dossier{count > 1 ? 's' : ''})
                    </option>
                  );
                })}
              </select>
            </div>
          </div>
          
          {/* Liste des dossiers à transférer */}
          {agenceSource && dossiersSource.length > 0 && (
            <div>
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '16px',
                padding: '12px 16px',
                background: 'var(--bg)',
                borderRadius: '8px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <input
                    type="checkbox"
                    checked={selectAll}
                    onChange={(e) => handleSelectAll(e.target.checked)}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontWeight: 600, fontSize: '14px' }}>
                    Sélectionner tout ({dossiersSource.length} dossiers)
                  </span>
                </div>
                <span style={{ 
                  padding: '4px 12px', 
                  background: selectedDossiers.length > 0 ? 'var(--brand)' : 'var(--muted)', 
                  color: 'white', 
                  borderRadius: '12px', 
                  fontSize: '13px',
                  fontWeight: 600 
                }}>
                  {selectedDossiers.length} sélectionné{selectedDossiers.length > 1 ? 's' : ''}
                </span>
              </div>
              
              <div style={{ 
                maxHeight: '400px', 
                overflowY: 'auto',
                border: '1px solid var(--line)',
                borderRadius: '8px'
              }}>
                <table>
                  <thead>
                    <tr>
                      <th style={{ width: '50px', textAlign: 'center' }}>✓</th>
                      <th>Nom du dossier</th>
                      <th>Régime fiscal</th>
                      <th>Régime TVA</th>
                      <th>Clôture</th>
                    </tr>
                  </thead>
                  <tbody>
                    {dossiersSource.map(dossier => (
                      <tr 
                        key={dossier.id}
                        style={{ 
                          background: selectedDossiers.includes(dossier.id) ? '#f0f4ff' : 'transparent',
                          cursor: 'pointer'
                        }}
                        onClick={() => handleSelectDossier(dossier.id)}
                      >
                        <td style={{ textAlign: 'center' }}>
                          <input
                            type="checkbox"
                            checked={selectedDossiers.includes(dossier.id)}
                            onChange={() => handleSelectDossier(dossier.id)}
                            style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                            onClick={(e) => e.stopPropagation()}
                          />
                        </td>
                        <td><strong>{dossier.nomDossier}</strong></td>
                        <td>
                          <span className="badge">{dossier.regimeFiscal}</span>
                        </td>
                        <td>
                          <span className="badge">{dossier.tva.regime}</span>
                        </td>
                        <td>{dossier.dateCloture}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              
              {/* Bouton de transfert */}
              <div style={{ 
                display: 'flex', 
                justifyContent: 'flex-end', 
                gap: '12px',
                marginTop: '24px',
                paddingTop: '24px',
                borderTop: '2px solid var(--line)'
              }}>
                <button 
                  className="btn"
                  onClick={() => {
                    setSelectedDossiers([]);
                    setSelectAll(false);
                  }}
                  disabled={selectedDossiers.length === 0}
                >
                  ✖️ Annuler la sélection
                </button>
                <button 
                  className="btn primary"
                  onClick={handleTransfert}
                  disabled={!agenceDestination || selectedDossiers.length === 0}
                  style={{ minWidth: '200px' }}
                >
                  🔄 Transférer {selectedDossiers.length > 0 ? `(${selectedDossiers.length})` : ''}
                </button>
              </div>
            </div>
          )}
          
          {agenceSource && dossiersSource.length === 0 && (
            <div style={{ 
              padding: '48px', 
              textAlign: 'center', 
              color: 'var(--muted)',
              background: 'var(--bg)',
              borderRadius: '12px',
              border: '2px dashed var(--line)'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>📂</div>
              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                Aucun dossier dans cette agence
              </div>
              <div style={{ fontSize: '14px' }}>
                L\'agence sélectionnée ne contient aucun dossier à transférer
              </div>
            </div>
          )}
          
          {!agenceSource && (
            <div style={{ 
              padding: '48px', 
              textAlign: 'center', 
              color: 'var(--muted)',
              background: 'var(--bg)',
              borderRadius: '12px',
              border: '2px dashed var(--line)'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>👆</div>
              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                Sélectionnez une agence source
              </div>
              <div style={{ fontSize: '14px' }}>
                Choisissez l\'agence depuis laquelle vous souhaitez transférer des dossiers
              </div>
            </div>
          )}
        </div>
      );
    }


    // ==================== ARCHIVAGE DOSSIERS (ADMIN) ====================
    function ArchivageDossiers({ dossiers, setDossiers, agencies, showToast }) {
      const [viewMode, setViewMode] = useState('actifs'); // 'actifs' ou 'archives'
      const [selectedDossiers, setSelectedDossiers] = useState([]);
      const [selectAll, setSelectAll] = useState(false);
      const [filterAgence, setFilterAgence] = useState('tous');
      
      // Filtrer les dossiers actifs et archivés
      const dossiersActifs = dossiers.filter(d => !d.archived);
      const dossiersArchives = dossiers.filter(d => d.archived);
      
      // Appliquer le filtre d'agence
      const currentDossiers = viewMode === 'actifs' ? dossiersActifs : dossiersArchives;
      const filteredDossiers = filterAgence === 'tous' 
        ? currentDossiers 
        : currentDossiers.filter(d => d.agence === filterAgence);
      
      // Gérer la sélection
      const handleSelectAll = (checked) => {
        setSelectAll(checked);
        if (checked) {
          setSelectedDossiers(filteredDossiers.map(d => d.id));
        } else {
          setSelectedDossiers([]);
        }
      };
      
      const handleSelectDossier = (dossierId) => {
        if (selectedDossiers.includes(dossierId)) {
          setSelectedDossiers(selectedDossiers.filter(id => id !== dossierId));
        } else {
          setSelectedDossiers([...selectedDossiers, dossierId]);
        }
      };
      
      // Archiver les dossiers sélectionnés
      const handleArchiver = () => {
        if (selectedDossiers.length === 0) {
          showToast('Veuillez sélectionner au moins un dossier à archiver', 'error');
          return;
        }
        
        if (!confirm(`⚠️ Archiver ${selectedDossiers.length} dossier(s) ?

Les dossiers archivés seront masqués des vues principales mais pourront être restaurés à tout moment.`)) {
          return;
        }
        
        const newDossiers = dossiers.map(d => 
          selectedDossiers.includes(d.id) ? { ...d, archived: true, archivedDate: new Date().toISOString() } : d
        );
        
        setDossiers(newDossiers);
        showToast(`${selectedDossiers.length} dossier(s) archivé(s) avec succès`, 'success');
        setSelectedDossiers([]);
        setSelectAll(false);
      };
      
      // Désarchiver les dossiers sélectionnés
      const handleDesarchiver = () => {
        if (selectedDossiers.length === 0) {
          showToast('Veuillez sélectionner au moins un dossier à désarchiver', 'error');
          return;
        }
        
        if (!confirm(`Désarchiver ${selectedDossiers.length} dossier(s) ?

Les dossiers seront restaurés et à nouveau visibles dans toutes les vues.`)) {
          return;
        }
        
        const newDossiers = dossiers.map(d => {
          if (selectedDossiers.includes(d.id)) {
            const { archived, archivedDate, ...rest } = d;
            return rest;
          }
          return d;
        });
        
        setDossiers(newDossiers);
        showToast(`${selectedDossiers.length} dossier(s) désarchivé(s) avec succès`, 'success');
        setSelectedDossiers([]);
        setSelectAll(false);
      };
      
      // Réinitialiser la sélection lors du changement de vue
      React.useEffect(() => {
        setSelectedDossiers([]);
        setSelectAll(false);
      }, [viewMode, filterAgence]);
      
      return (
        <div className="panel">
          <div style={{ marginBottom: '24px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '8px' }}>
              📦 Archivage des dossiers
            </h2>
            <p style={{ color: 'var(--muted)', fontSize: '14px' }}>
              Archiver ou restaurer des dossiers pour organiser votre base de données
            </p>
          </div>
          
          {/* Statistiques */}
          <div className="grid-3" style={{ marginBottom: '24px' }}>
            <div style={{ padding: '20px', background: '#f0f4ff', borderRadius: '12px', border: '2px solid #dbeafe' }}>
              <div style={{ fontSize: '32px', fontWeight: 700, color: 'var(--brand)', marginBottom: '4px' }}>
                {dossiersActifs.length}
              </div>
              <div style={{ fontSize: '13px', color: 'var(--muted)', fontWeight: 600 }}>
                📂 Dossiers actifs
              </div>
            </div>
            <div style={{ padding: '20px', background: '#fef3c7', borderRadius: '12px', border: '2px solid #fcd34d' }}>
              <div style={{ fontSize: '32px', fontWeight: 700, color: '#d97706', marginBottom: '4px' }}>
                {dossiersArchives.length}
              </div>
              <div style={{ fontSize: '13px', color: 'var(--muted)', fontWeight: 600 }}>
                📦 Dossiers archivés
              </div>
            </div>
            <div style={{ padding: '20px', background: '#f0fdf4', borderRadius: '12px', border: '2px solid #86efac' }}>
              <div style={{ fontSize: '32px', fontWeight: 700, color: '#16a34a', marginBottom: '4px' }}>
                {selectedDossiers.length}
              </div>
              <div style={{ fontSize: '13px', color: 'var(--muted)', fontWeight: 600 }}>
                ✓ Dossiers sélectionnés
              </div>
            </div>
          </div>
          
          {/* Filtres et actions */}
          <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            marginBottom: '20px',
            gap: '16px',
            flexWrap: 'wrap'
          }}>
            <div style={{ display: 'flex', gap: '8px' }}>
              <button
                className={`btn ${viewMode === 'actifs' ? 'primary' : ''}`}
                onClick={() => setViewMode('actifs')}
              >
                📂 Actifs ({dossiersActifs.length})
              </button>
              <button
                className={`btn ${viewMode === 'archives' ? 'primary' : ''}`}
                onClick={() => setViewMode('archives')}
              >
                📦 Archives ({dossiersArchives.length})
              </button>
            </div>
            
            <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
              <select 
                className="form-control" 
                value={filterAgence}
                onChange={(e) => setFilterAgence(e.target.value)}
                style={{ minWidth: '200px' }}
              >
                <option value="tous">Toutes les agences</option>
                {agencies.filter(a => a.id !== 'tous').map(agency => {
                  const count = currentDossiers.filter(d => d.agence === agency.id).length;
                  return (
                    <option key={agency.id} value={agency.id}>
                      {agency.name} ({count})
                    </option>
                  );
                })}
              </select>
            </div>
          </div>
          
          {/* Liste des dossiers */}
          {filteredDossiers.length > 0 ? (
            <>
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '16px',
                padding: '12px 16px',
                background: 'var(--bg)',
                borderRadius: '8px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <input
                    type="checkbox"
                    checked={selectAll}
                    onChange={(e) => handleSelectAll(e.target.checked)}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontWeight: 600, fontSize: '14px' }}>
                    Sélectionner tout ({filteredDossiers.length} dossiers)
                  </span>
                </div>
                <div style={{ display: 'flex', gap: '8px' }}>
                  {viewMode === 'actifs' && (
                    <button 
                      className="btn primary"
                      onClick={handleArchiver}
                      disabled={selectedDossiers.length === 0}
                    >
                      📦 Archiver ({selectedDossiers.length})
                    </button>
                  )}
                  {viewMode === 'archives' && (
                    <button 
                      className="btn primary"
                      onClick={handleDesarchiver}
                      disabled={selectedDossiers.length === 0}
                    >
                      📂 Désarchiver ({selectedDossiers.length})
                    </button>
                  )}
                </div>
              </div>
              
              <div style={{ 
                maxHeight: '500px', 
                overflowY: 'auto',
                border: '1px solid var(--line)',
                borderRadius: '8px'
              }}>
                <table>
                  <thead>
                    <tr>
                      <th style={{ width: '50px', textAlign: 'center' }}>✓</th>
                      <th>Nom du dossier</th>
                      <th>Agence</th>
                      <th>Régime fiscal</th>
                      <th>TVA</th>
                      <th>Clôture</th>
                      {viewMode === 'archives' && <th>Date archivage</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {filteredDossiers.map(dossier => {
                      const agence = agencies.find(a => a.id === dossier.agence);
                      return (
                        <tr 
                          key={dossier.id}
                          style={{ 
                            background: selectedDossiers.includes(dossier.id) ? '#f0f4ff' : 'transparent',
                            cursor: 'pointer'
                          }}
                          onClick={() => handleSelectDossier(dossier.id)}
                        >
                          <td style={{ textAlign: 'center' }}>
                            <input
                              type="checkbox"
                              checked={selectedDossiers.includes(dossier.id)}
                              onChange={() => handleSelectDossier(dossier.id)}
                              style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                              onClick={(e) => e.stopPropagation()}
                            />
                          </td>
                          <td><strong>{dossier.nomDossier}</strong></td>
                          <td>
                            <span className="badge" style={{ background: agence?.color + '20', color: agence?.color }}>
                              {agence?.name || 'N/A'}
                            </span>
                          </td>
                          <td><span className="badge">{dossier.regimeFiscal}</span></td>
                          <td><span className="badge">{dossier.tva.regime}</span></td>
                          <td>{dossier.dateCloture}</td>
                          {viewMode === 'archives' && (
                            <td style={{ fontSize: '12px', color: 'var(--muted)' }}>
                              {dossier.archivedDate ? new Date(dossier.archivedDate).toLocaleDateString('fr-FR') : '-'}
                            </td>
                          )}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </>
          ) : (
            <div style={{ 
              padding: '48px', 
              textAlign: 'center', 
              color: 'var(--muted)',
              background: 'var(--bg)',
              borderRadius: '12px',
              border: '2px dashed var(--line)'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>
                {viewMode === 'actifs' ? '📂' : '📦'}
              </div>
              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                Aucun dossier {viewMode === 'archives' ? 'archivé' : 'actif'}
              </div>
              <div style={{ fontSize: '14px' }}>
                {viewMode === 'actifs' 
                  ? 'Tous les dossiers sont archivés' 
                  : 'Aucun dossier n\'est archivé pour le moment'}
              </div>
            </div>
          )}
        </div>
      );
    }


    // ==================== AJOUT EN MASSE RÉVISION ====================
    function AjoutMasseRevision({ dossiers, setDossiers, agencies, showToast, currentUser }) {
      const [typeRevision, setTypeRevision] = useState('simple'); // 'simple' ou 'annuelle'
      const [selectedDossiers, setSelectedDossiers] = useState([]);
      const [selectAll, setSelectAll] = useState(false);
      const [filterAgence, setFilterAgence] = useState('tous');
      
      // Paramètres pour révision simplifiée
      const [cycleSimple, setCycleSimple] = useState({
        mois: new Date().getMonth() + 1,
        annee: new Date().getFullYear()
      });
      
      // Paramètres pour révision annuelle
      const [exerciceAnnuel, setExerciceAnnuel] = useState(new Date().getFullYear());
      
      // Filtrer les dossiers selon le type de révision et qui ne sont pas archivés
      const dossiersDisponibles = dossiers.filter(d => {
        if (d.archived) return false;
        
        // Filtre par agence (admin voit tout, chef d'agence voit son agence)
        if (currentUser.role === 'Chef d\'agence') {
          if (!currentUser.agences.includes(d.agence) && !currentUser.agences.includes('tous')) {
            return false;
          }
        }
        
        if (typeRevision === 'simple') {
          return d.regimeFiscal === 'IR' || d.tva.regime === 'Réel simplifié';
        } else {
          return d.regimeFiscal === 'IS';
        }
      });
      
      // Appliquer le filtre d'agence
      const filteredDossiers = filterAgence === 'tous' 
        ? dossiersDisponibles 
        : dossiersDisponibles.filter(d => d.agence === filterAgence);
      
      const handleSelectAll = (checked) => {
        setSelectAll(checked);
        if (checked) {
          setSelectedDossiers(filteredDossiers.map(d => d.id));
        } else {
          setSelectedDossiers([]);
        }
      };
      
      const handleSelectDossier = (dossierId) => {
        if (selectedDossiers.includes(dossierId)) {
          setSelectedDossiers(selectedDossiers.filter(id => id !== dossierId));
        } else {
          setSelectedDossiers([...selectedDossiers, dossierId]);
        }
      };
      
      const handleAjouterRevision = () => {
        if (selectedDossiers.length === 0) {
          showToast('Veuillez sélectionner au moins un dossier', 'error');
          return;
        }
        
        let message = '';
        if (typeRevision === 'simple') {
          const moisNom = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'][cycleSimple.mois - 1];
          message = `Ajouter ${selectedDossiers.length} dossier(s) à la révision simplifiée
Cycle: ${moisNom} ${cycleSimple.annee}`;
        } else {
          message = `Ajouter ${selectedDossiers.length} dossier(s) à la révision annuelle
Exercice: ${exerciceAnnuel}`;
        }
        
        if (!confirm(message + '

Confirmer ?')) {
          return;
        }
        
        const newDossiers = dossiers.map(d => {
          if (selectedDossiers.includes(d.id)) {
            if (typeRevision === 'simple') {
              return {
                ...d,
                revision_simple: {
                  actif: true,
                  euroAttache: 0,
                  cycle: `${String(cycleSimple.mois).padStart(2, '0')}/${cycleSimple.annee}`,
                  cycles: d.revision_simple?.cycles || JSON.parse(JSON.stringify(getConfiguredCyclesSimple()))
                }
              };
            } else {
              return {
                ...d,
                revision_annuelle: {
                  actif: true,
                  exercice: exerciceAnnuel,
                  cycles: d.revision_annuelle?.cycles || JSON.parse(JSON.stringify(getConfiguredCyclesAnnuelle()))
                }
              };
            }
          }
          return d;
        });
        
        setDossiers(newDossiers);
        
        if (typeRevision === 'simple') {
          const moisNom = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                          'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'][cycleSimple.mois - 1];
          showToast(`${selectedDossiers.length} dossier(s) ajouté(s) à la révision simplifiée (${moisNom} ${cycleSimple.annee})`, 'success');
        } else {
          showToast(`${selectedDossiers.length} dossier(s) ajouté(s) à la révision annuelle (Exercice ${exerciceAnnuel})`, 'success');
        }
        
        setSelectedDossiers([]);
        setSelectAll(false);
      };
      
      React.useEffect(() => {
        setSelectedDossiers([]);
        setSelectAll(false);
      }, [typeRevision, filterAgence]);
      
      return (
        <div className="panel">
          <div style={{ marginBottom: '24px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '8px' }}>
              ➕ Ajout en masse à la révision
            </h2>
            <p style={{ color: 'var(--muted)', fontSize: '14px' }}>
              Ajouter plusieurs dossiers simultanément à un cycle de révision
            </p>
          </div>
          
          {/* Sélection du type de révision */}
          <div style={{ marginBottom: '24px' }}>
            <label className="form-label" style={{ marginBottom: '12px', display: 'block', fontWeight: 600 }}>
              📋 Type de révision
            </label>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button
                className={`btn ${typeRevision === 'simple' ? 'primary' : ''}`}
                onClick={() => setTypeRevision('simple')}
                style={{ flex: 1 }}
              >
                📋 Révision Simplifiée
              </button>
              <button
                className={`btn ${typeRevision === 'annuelle' ? 'primary' : ''}`}
                onClick={() => setTypeRevision('annuelle')}
                style={{ flex: 1 }}
              >
                📊 Révision Annuelle
              </button>
            </div>
          </div>
          
          {/* Paramètres du cycle */}
          <div style={{ 
            padding: '20px', 
            background: '#f0f4ff', 
            borderRadius: '12px', 
            marginBottom: '24px',
            border: '2px solid #dbeafe'
          }}>
            <h3 style={{ fontSize: '15px', fontWeight: 700, marginBottom: '16px', color: 'var(--brand)' }}>
              ⚙️ Paramètres du cycle
            </h3>
            
            {typeRevision === 'simple' ? (
              <div className="grid-2" style={{ gap: '16px' }}>
                <div>
                  <label className="form-label">Mois</label>
                  <select
                    className="form-control"
                    value={cycleSimple.mois}
                    onChange={(e) => setCycleSimple({ ...cycleSimple, mois: parseInt(e.target.value) })}
                  >
                    {['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 
                      'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'].map((m, idx) => (
                      <option key={idx} value={idx + 1}>{m}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="form-label">Année</label>
                  <input
                    type="number"
                    className="form-control"
                    value={cycleSimple.annee}
                    onChange={(e) => setCycleSimple({ ...cycleSimple, annee: parseInt(e.target.value) })}
                    min="2020"
                    max="2030"
                  />
                </div>
              </div>
            ) : (
              <div>
                <label className="form-label">Exercice comptable</label>
                <input
                  type="number"
                  className="form-control"
                  value={exerciceAnnuel}
                  onChange={(e) => setExerciceAnnuel(parseInt(e.target.value))}
                  min="2020"
                  max="2030"
                  style={{ maxWidth: '200px' }}
                />
              </div>
            )}
          </div>
          
          {/* Filtres */}
          <div style={{ 
            display: 'flex', 
            justifyContent: 'space-between', 
            alignItems: 'center',
            marginBottom: '20px',
            gap: '16px',
            flexWrap: 'wrap'
          }}>
            <div style={{ fontSize: '14px', fontWeight: 600 }}>
              {typeRevision === 'simple' 
                ? '📋 Dossiers éligibles (IR ou Réel simplifié)' 
                : '📊 Dossiers éligibles (IS)'}
            </div>
            
            <select 
              className="form-control" 
              value={filterAgence}
              onChange={(e) => setFilterAgence(e.target.value)}
              style={{ minWidth: '200px' }}
            >
              <option value="tous">Toutes les agences</option>
              {agencies.filter(a => a.id !== 'tous').map(agency => {
                const count = dossiersDisponibles.filter(d => d.agence === agency.id).length;
                return (
                  <option key={agency.id} value={agency.id}>
                    {agency.name} ({count})
                  </option>
                );
              })}
            </select>
          </div>
          
          {/* Liste des dossiers */}
          {filteredDossiers.length > 0 ? (
            <>
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                marginBottom: '16px',
                padding: '12px 16px',
                background: 'var(--bg)',
                borderRadius: '8px'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <input
                    type="checkbox"
                    checked={selectAll}
                    onChange={(e) => handleSelectAll(e.target.checked)}
                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                  />
                  <span style={{ fontWeight: 600, fontSize: '14px' }}>
                    Sélectionner tout ({filteredDossiers.length} dossiers)
                  </span>
                </div>
                <button 
                  className="btn primary"
                  onClick={handleAjouterRevision}
                  disabled={selectedDossiers.length === 0}
                  style={{ minWidth: '200px' }}
                >
                  ➕ Ajouter à la révision ({selectedDossiers.length})
                </button>
              </div>
              
              <div style={{ 
                maxHeight: '400px', 
                overflowY: 'auto',
                border: '1px solid var(--line)',
                borderRadius: '8px'
              }}>
                <table>
                  <thead>
                    <tr>
                      <th style={{ width: '50px', textAlign: 'center' }}>✓</th>
                      <th>Nom du dossier</th>
                      <th>Agence</th>
                      <th>Régime fiscal</th>
                      <th>TVA</th>
                      <th>Clôture</th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredDossiers.map(dossier => {
                      const agence = agencies.find(a => a.id === dossier.agence);
                      return (
                        <tr 
                          key={dossier.id}
                          style={{ 
                            background: selectedDossiers.includes(dossier.id) ? '#f0f4ff' : 'transparent',
                            cursor: 'pointer'
                          }}
                          onClick={() => handleSelectDossier(dossier.id)}
                        >
                          <td style={{ textAlign: 'center' }}>
                            <input
                              type="checkbox"
                              checked={selectedDossiers.includes(dossier.id)}
                              onChange={() => handleSelectDossier(dossier.id)}
                              style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                              onClick={(e) => e.stopPropagation()}
                            />
                          </td>
                          <td><strong>{dossier.nomDossier}</strong></td>
                          <td>
                            <span className="badge" style={{ background: agence?.color + '20', color: agence?.color }}>
                              {agence?.name || 'N/A'}
                            </span>
                          </td>
                          <td><span className="badge">{dossier.regimeFiscal}</span></td>
                          <td><span className="badge">{dossier.tva.regime}</span></td>
                          <td>{dossier.dateCloture}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </>
          ) : (
            <div style={{ 
              padding: '48px', 
              textAlign: 'center', 
              color: 'var(--muted)',
              background: 'var(--bg)',
              borderRadius: '12px',
              border: '2px dashed var(--line)'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}>📂</div>
              <div style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                Aucun dossier éligible
              </div>
              <div style={{ fontSize: '14px' }}>
                {typeRevision === 'simple' 
                  ? 'Aucun dossier en IR ou Réel simplifié disponible' 
                  : 'Aucun dossier en IS disponible'}
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==================== RIGHTS MANAGEMENT ====================
    function RightsManagement({ users, setUsers, showToast }) {
      return (
        <div className="panel">
          <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '16px' }}>
            🔐 Gestion des droits et cycles
          </h2>
          
          <div style={{ marginBottom: '24px', padding: '16px', background: '#f0f4ff', borderRadius: '12px', border: '1px solid #dbeafe' }}>
            <h3 style={{ fontSize: '16px', fontWeight: 700, marginBottom: '12px', color: 'var(--brand)' }}>
              📋 Cycles de révision disponibles
            </h3>
            <div className="grid-2" style={{ gap: '16px' }}>
              <div style={{ padding: '16px', background: 'white', borderRadius: '10px', border: '1px solid var(--line)' }}>
                <div style={{ fontSize: '14px', fontWeight: 700, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  📋 Cycle Simplifié
                  <span style={{ padding: '2px 8px', background: '#d1fae5', color: '#065f46', borderRadius: '6px', fontSize: '11px', fontWeight: 600 }}>
                    {getConfiguredCyclesSimple().length} cycles
                  </span>
                </div>
                <div style={{ fontSize: '12px', color: 'var(--muted)', marginBottom: '12px' }}>
                  Pour les dossiers en régime simplifié (IR, Réel simplifié)
                </div>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                  {getConfiguredCyclesSimple().map((cycle, idx) => (
                    <span key={idx} className="badge" style={{ fontSize: '11px', padding: '4px 8px' }}>
                      {cycle.name}
                    </span>
                  ))}
                </div>
              </div>
              
              <div style={{ padding: '16px', background: 'white', borderRadius: '10px', border: '1px solid var(--line)' }}>
                <div style={{ fontSize: '14px', fontWeight: 700, marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  📊 Cycle Annuel (Bilan)
                  <span style={{ padding: '2px 8px', background: '#dbeafe', color: '#1e40af', borderRadius: '6px', fontSize: '11px', fontWeight: 600 }}>
                    {getConfiguredCyclesAnnuelle().length} cycles
                  </span>
                </div>
                <div style={{ fontSize: '12px', color: 'var(--muted)', marginBottom: '12px' }}>
                  Pour les dossiers IS avec révision comptable complète
                </div>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                  {getConfiguredCyclesAnnuelle().map((cycle, idx) => (
                    <span key={idx} className="badge" style={{ fontSize: '11px', padding: '4px 8px' }}>
                      {cycle.name}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>
          
          <h3 style={{ fontSize: '16px', fontWeight: 700, marginBottom: '12px' }}>
            👥 Attribution des droits par utilisateur
          </h3>
          
          <table>
            <thead>
              <tr>
                <th>Utilisateur</th>
                <th>Rôle</th>
                <th style={{ textAlign: 'center' }}>Créer Cycle Simplifié</th>
                <th style={{ textAlign: 'center' }}>Créer Cycle Annuel</th>
                <th style={{ textAlign: 'center' }}>Modifier Cycles</th>
                <th style={{ textAlign: 'center' }}>Valider Révision</th>
              </tr>
            </thead>
            <tbody>
              {users.map(u => (
                <tr key={u.id}>
                  <td><strong>{u.prenom} {u.nom}</strong></td>
                  <td>
                    <span className="badge" style={{
                      background: u.role === 'Admin' ? '#fce7f3' : u.role === 'Chef d\'agence' ? '#dbeafe' : '#f3f4f6',
                      color: u.role === 'Admin' ? '#9f1239' : u.role === 'Chef d\'agence' ? '#1e40af' : '#4b5563',
                      borderColor: u.role === 'Admin' ? '#f9a8d4' : u.role === 'Chef d\'agence' ? '#93c5fd' : '#d1d5db'
                    }}>
                      {u.role}
                    </span>
                  </td>
                  <td style={{ textAlign: 'center' }}>
                    <input 
                      type="checkbox" 
                      checked={u.role === 'Admin' || u.role === 'Chef d\'agence'}
                      disabled={u.role === 'Admin'}
                      style={{ width: '18px', height: '18px', cursor: u.role === 'Admin' ? 'not-allowed' : 'pointer' }}
                    />
                  </td>
                  <td style={{ textAlign: 'center' }}>
                    <input 
                      type="checkbox" 
                      checked={u.role === 'Admin' || u.role === 'Chef d\'agence'}
                      disabled={u.role === 'Admin'}
                      style={{ width: '18px', height: '18px', cursor: u.role === 'Admin' ? 'not-allowed' : 'pointer' }}
                    />
                  </td>
                  <td style={{ textAlign: 'center' }}>
                    <input 
                      type="checkbox" 
                      checked={true}
                      disabled={u.role === 'Comptable'}
                      style={{ width: '18px', height: '18px', cursor: u.role === 'Comptable' ? 'not-allowed' : 'pointer' }}
                    />
                  </td>
                  <td style={{ textAlign: 'center' }}>
                    <input 
                      type="checkbox" 
                      checked={u.role === 'Admin' || u.role === 'Chef d\'agence'}
                      disabled={u.role === 'Admin'}
                      style={{ width: '18px', height: '18px', cursor: u.role === 'Admin' ? 'not-allowed' : 'pointer' }}
                    />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          
          <div style={{ marginTop: '20px', padding: '12px', background: '#fef3c7', borderRadius: '10px', border: '1px solid #fcd34d' }}>
            <div style={{ fontSize: '12px', color: '#92400e' }}>
              <strong>ℹ️ Note :</strong> Les administrateurs ont automatiquement tous les droits. Les chefs d'agence peuvent créer et valider les révisions pour leurs agences.
            </div>
          </div>
        </div>
      );
    }
    
    // ==================== REVISION SIMPLE VIEW ====================
    function RevisionSimpleView({ dossiers, showToast }) {
      return (
        <div className="panel">
          <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '16px' }}>
            📋 Révision Simplifié
          </h2>
          
          <table>
            <thead>
              <tr>
                <th>Dossier</th>
                <th>Client</th>
                <th>Régime</th>
                <th>Statut Révision</th>
                <th>Cycles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {dossiers.filter(d => d.regimeFiscal === 'IR' || d.tva.regime === 'Réel simplifié').map(d => (
                <tr key={d.id}>
                  <td><strong>{d.number}</strong></td>
                  <td>{d.name}</td>
                  <td>
                    <span className="badge">
                      {d.tva.regime}
                    </span>
                  </td>
                  <td>
                    <span className={`picto-badge picto-revision ${
                      d.revision.statut === 'Validé' ? '' : 
                      d.revision.statut === 'En cours' ? 'en-cours' : 
                      'non-commence'
                    }`}>
                      {d.revision.statut}
                    </span>
                  </td>
                  <td style={{ fontSize: '12px', color: 'var(--muted)' }}>
                    {d.revision.cycles.length} cycle(s)
                  </td>
                  <td>
                    <button className="btn small">📝 Réviser</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }
    
    // ==================== REVISION ANNUELLE VIEW ====================
    function RevisionAnnuelleView({ dossiers, showToast }) {
      return (
        <div className="panel">
          <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '16px' }}>
            📊 Révision Annuelle
          </h2>
          
          <table>
            <thead>
              <tr>
                <th>Dossier</th>
                <th>Client</th>
                <th>Régime</th>
                <th>Clôture</th>
                <th>Statut Révision</th>
                <th>Cycles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {dossiers.map(d => (
                <tr key={d.id}>
                  <td><strong>{d.number}</strong></td>
                  <td>{d.name}</td>
                  <td>
                    <span className="badge" style={{ 
                      background: d.regimeFiscal === 'IS' ? '#dbeafe' : '#fef3c7',
                      color: d.regimeFiscal === 'IS' ? '#1e40af' : '#92400e',
                      borderColor: d.regimeFiscal === 'IS' ? '#93c5fd' : '#fcd34d'
                    }}>
                      {d.regimeFiscal}
                    </span>
                  </td>
                  <td>{d.cloture}</td>
                  <td>
                    <span className={`picto-badge picto-revision ${
                      d.revision.statut === 'Validé' ? '' : 
                      d.revision.statut === 'En cours' ? 'en-cours' : 
                      'non-commence'
                    }`}>
                      {d.revision.statut}
                    </span>
                  </td>
                  <td style={{ fontSize: '12px', color: 'var(--muted)' }}>
                    {d.revision.cycles.length} cycle(s)
                  </td>
                  <td>
                    <button className="btn small primary">📊 Réviser</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }
    
    // ==================== MODAL DOSSIER ====================
    function DossierModal({ dossier, onSave, onClose, agencies, currentUser }) {
      const [formData, setFormData] = useState(dossier || {
        number: '',
        siren: '',
        siret: '',
        name: '',
        activite: '',
        cloture: '',
        regimeFiscal: 'IS',
        agency: currentUser.agences[0],
        tva: {
          regime: 'Réel normal',
          periodicite: 'Mensuelle',
          jour: '',
          type: 'Débit',
          statut: '',
          notes: ''
        },
        cfe: { actif: false, statut: 'To do', notes: '' },
        tvs: { actif: false, vehicules: [], notes: '' },
        irpp: { actif: false, notes: '' },
        revision: { statut: 'Non commencé', cycles: [] }
      });
      
      const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
      };
      
      const updateField = (field, value) => {
        setFormData({...formData, [field]: value});
      };
      
      const updateNestedField = (parent, field, value) => {
        setFormData({
          ...formData,
          [parent]: {
            ...formData[parent],
            [field]: value
          }
        });
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 style={{fontSize: '20px', fontWeight: 700}}>
                {dossier ? 'Modifier le dossier' : 'Nouveau dossier'}
              </h2>
              <button onClick={onClose} className="btn small">✕</button>
            </div>
            
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: 700, marginBottom: '16px' }}>
                    📋 Informations générales
                  </h3>
                  
                  <div className="grid-2">
                    <div className="form-group">
                      <label className="form-label">N° Dossier *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={formData.number}
                        onChange={(e) => updateField('number', e.target.value)}
                        required
                      />
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">Agence *</label>
                      <select
                        className="form-control"
                        value={formData.agency}
                        onChange={(e) => updateField('agency', e.target.value)}
                        required
                      >
                        {agencies.filter(a => a.id !== 'tous').map(agency => (
                          <option key={agency.id} value={agency.id}>{agency.name}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">SIREN *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={formData.siren}
                        onChange={(e) => updateField('siren', e.target.value)}
                        maxLength="9"
                        required
                      />
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">SIRET *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={formData.siret}
                        onChange={(e) => updateField('siret', e.target.value)}
                        maxLength="14"
                        required
                      />
                    </div>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Raison Sociale *</label>
                    <input
                      type="text"
                      className="form-control"
                      value={formData.name}
                      onChange={(e) => updateField('name', e.target.value)}
                      required
                    />
                  </div>
                  
                  <div className="grid-2">
                    <div className="form-group">
                      <label className="form-label">Activité *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={formData.activite}
                        onChange={(e) => updateField('activite', e.target.value)}
                        required
                      />
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">Date Clôture *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={formData.cloture}
                        onChange={(e) => updateField('cloture', e.target.value)}
                        placeholder="31/12/2024"
                        required
                      />
                    </div>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Régime Fiscal *</label>
                    <div className="radio-group">
                      <label className={`radio-label ${formData.regimeFiscal === 'IS' ? 'checked' : ''}`}>
                        <input
                          type="radio"
                          name="regimeFiscal"
                          value="IS"
                          checked={formData.regimeFiscal === 'IS'}
                          onChange={(e) => updateField('regimeFiscal', e.target.value)}
                        />
                        <span>IS (Impôt sur les Sociétés)</span>
                      </label>
                      <label className={`radio-label ${formData.regimeFiscal === 'IR' ? 'checked' : ''}`}>
                        <input
                          type="radio"
                          name="regimeFiscal"
                          value="IR"
                          checked={formData.regimeFiscal === 'IR'}
                          onChange={(e) => updateField('regimeFiscal', e.target.value)}
                        />
                        <span>IR (Impôt sur le Revenu)</span>
                      </label>
                    </div>
                  </div>
                </div>
                
                <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr', gap: '12px', marginBottom: '20px' }}>
                  <div className="section-box tva-box" style={{ padding: '12px' }}>
                    <div className="section-title" style={{ fontSize: '13px', marginBottom: '10px' }}>💰 TVA</div>
                    
                    <div className="form-group" style={{ marginBottom: '8px' }}>
                      <label className="form-label" style={{ fontSize: '11px' }}>Régime *</label>
                      <select
                        className="form-control"
                        style={{ padding: '6px 8px', fontSize: '12px' }}
                        value={formData.tva.regime}
                        onChange={(e) => updateNestedField('tva', 'regime', e.target.value)}
                        required
                      >
                        <option value="Réel normal">Réel normal</option>
                        <option value="Réel simplifié">Réel simplifié</option>
                        <option value="Franchise en base">Franchise</option>
                      </select>
                    </div>
                    
                    {formData.tva.regime !== "Franchise en base" && (
                      <>
                        <div className="form-group" style={{ marginBottom: '8px' }}>
                          <label className="form-label" style={{ fontSize: '11px' }}>Périodicité</label>
                          <select
                            className="form-control"
                            style={{ padding: '6px 8px', fontSize: '12px' }}
                            value={formData.tva.periodicite}
                            onChange={(e) => updateNestedField('tva', 'periodicite', e.target.value)}
                          >
                            <option value="">Sélectionner...</option>
                            <option value="Mensuelle">Mensuelle</option>
                            <option value="Trimestrielle">Trimestrielle</option>
                            <option value="Annuelle">Annuelle</option>
                          </select>
                        </div>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                          <div className="form-group" style={{ marginBottom: '0' }}>
                            <label className="form-label" style={{ fontSize: '11px' }}>Jour</label>
                            <input
                              type="text"
                              className="form-control"
                              style={{ padding: '6px 8px', fontSize: '12px' }}
                              value={formData.tva.jour}
                              onChange={(e) => updateNestedField('tva', 'jour', e.target.value)}
                              placeholder="19"
                            />
                          </div>
                          
                          <div className="form-group" style={{ marginBottom: '0' }}>
                            <label className="form-label" style={{ fontSize: '11px' }}>Type</label>
                            <select
                              className="form-control"
                              style={{ padding: '6px 8px', fontSize: '12px' }}
                              value={formData.tva.type}
                              onChange={(e) => updateNestedField('tva', 'type', e.target.value)}
                            >
                              <option value="">...</option>
                              <option value="Débit">Débit</option>
                              <option value="Encaissement">Encais.</option>
                            </select>
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                  
                  <div className="section-box cfe-box" style={{ padding: '12px' }}>
                    <div className="section-title" style={{ fontSize: '13px', marginBottom: '10px' }}>
                      <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer' }}>
                        <input
                          type="checkbox"
                          checked={formData.cfe.actif}
                          onChange={(e) => updateNestedField('cfe', 'actif', e.target.checked)}
                          style={{ width: '16px', height: '16px' }}
                        />
                        <span style={{ fontSize: '13px' }}>🏢 CFE</span>
                      </label>
                    </div>
                    
                    {formData.cfe.actif && (
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label className="form-label" style={{ fontSize: '11px' }}>Notes</label>
                        <textarea
                          className="form-control"
                          style={{ padding: '6px 8px', fontSize: '11px' }}
                          value={formData.cfe.notes}
                          onChange={(e) => updateNestedField('cfe', 'notes', e.target.value)}
                          rows="3"
                        />
                      </div>
                    )}
                  </div>
                  
                  <div className="section-box irpp-box" style={{ padding: '12px' }}>
                    <div className="section-title" style={{ fontSize: '13px', marginBottom: '10px' }}>
                      <label style={{ display: 'flex', alignItems: 'center', gap: '6px', cursor: 'pointer' }}>
                        <input
                          type="checkbox"
                          checked={formData.irpp.actif}
                          onChange={(e) => updateNestedField('irpp', 'actif', e.target.checked)}
                          style={{ width: '16px', height: '16px' }}
                        />
                        <span style={{ fontSize: '13px' }}>📄 IRPP</span>
                      </label>
                    </div>
                    
                    {formData.irpp.actif && (
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label className="form-label" style={{ fontSize: '11px' }}>Notes</label>
                        <textarea
                          className="form-control"
                          style={{ padding: '6px 8px', fontSize: '11px' }}
                          value={formData.irpp.notes}
                          onChange={(e) => updateNestedField('irpp', 'notes', e.target.value)}
                          rows="3"
                        />
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="section-box tvs-box" style={{ padding: '16px' }}>
                  <div className="section-title" style={{ fontSize: '14px', marginBottom: '12px' }}>
                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                      <input
                        type="checkbox"
                        checked={formData.tvs.actif}
                        onChange={(e) => updateNestedField('tvs', 'actif', e.target.checked)}
                        style={{ width: '18px', height: '18px' }}
                      />
                      <span>🚗 TVS (Taxe sur les Véhicules de Société)</span>
                    </label>
                  </div>
                  
                  {formData.tvs.actif && (
                    <>
                      <div className="form-group">
                        <label className="form-label" style={{ fontSize: '12px' }}>Notes</label>
                        <textarea
                          className="form-control"
                          style={{ padding: '8px 10px', fontSize: '13px' }}
                          value={formData.tvs.notes}
                          onChange={(e) => updateNestedField('tvs', 'notes', e.target.value)}
                          rows="2"
                        />
                      </div>
                      
                      <div style={{ marginTop: '16px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                          <label className="form-label" style={{ fontSize: '13px', marginBottom: '0', fontWeight: 700 }}>
                            Véhicules ({formData.tvs.vehicules?.length || 0})
                          </label>
                          <button 
                            type="button"
                            className="btn small primary"
                            onClick={() => {
                              const newVehicule = {
                                immat: '',
                                modele: '',
                                type: 'essence',
                                puissance: 0,
                                co2: 0,
                                anneeCirculation: new Date().getFullYear(),
                                trimestres: 4,
                                dateAchat: '',
                                dateVente: ''
                              };
                              updateNestedField('tvs', 'vehicules', [...(formData.tvs.vehicules || []), newVehicule]);
                            }}
                          >
                            ➕ Ajouter un véhicule
                          </button>
                        </div>
                        
                        {formData.tvs.vehicules && formData.tvs.vehicules.length > 0 && (
                          <div style={{ border: '1px solid var(--line)', borderRadius: '8px', overflow: 'hidden' }}>
                            {formData.tvs.vehicules.map((vehicule, idx) => {
                              const calcul = calculateTVS2025(vehicule);
                              return (
                                <div key={idx} style={{ 
                                  padding: '12px', 
                                  borderBottom: idx < formData.tvs.vehicules.length - 1 ? '1px solid var(--line)' : 'none',
                                  background: idx % 2 === 0 ? 'white' : '#fafbfc'
                                }}>
                                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1.2fr 1fr 1.2fr 0.8fr 0.6fr 0.6fr 1fr auto', gap: '8px', alignItems: 'end' }}>
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>Date achat *</label>
                                      <input
                                        type="date"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.dateAchat || ''}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].dateAchat = e.target.value;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        required
                                      />
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>Immatriculation *</label>
                                      <input
                                        type="text"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.immat}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].immat = e.target.value;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        placeholder="AA-123-BB"
                                        required
                                      />
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>Marque *</label>
                                      <input
                                        type="text"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.marque || ''}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].marque = e.target.value;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        placeholder="Renault"
                                        required
                                      />
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>Modèle *</label>
                                      <input
                                        type="text"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.modele}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].modele = e.target.value;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        placeholder="Clio"
                                        required
                                      />
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>Type *</label>
                                      <select
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.type}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].type = e.target.value;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        required
                                      >
                                        <option value="essence">Essence</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="electrique">Électrique</option>
                                        <option value="hydrogene">Hydrogène</option>
                                      </select>
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>CV *</label>
                                      <input
                                        type="number"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.puissance}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].puissance = parseInt(e.target.value) || 0;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        min="0"
                                        required
                                      />
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>CO2 *</label>
                                      <input
                                        type="number"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.co2}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].co2 = parseInt(e.target.value) || 0;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                        min="0"
                                        required
                                      />
                                    </div>
                                    
                                    <div className="form-group" style={{ marginBottom: '0' }}>
                                      <label className="form-label" style={{ fontSize: '11px' }}>Date vente</label>
                                      <input
                                        type="date"
                                        className="form-control"
                                        style={{ padding: '6px 8px', fontSize: '12px' }}
                                        value={vehicule.dateVente || ''}
                                        onChange={(e) => {
                                          const newVehicules = [...formData.tvs.vehicules];
                                          newVehicules[idx].dateVente = e.target.value;
                                          updateNestedField('tvs', 'vehicules', newVehicules);
                                        }}
                                      />
                                    </div>
                                    
                                    <button 
                                      type="button"
                                      className="btn small danger"
                                      style={{ padding: '6px 10px' }}
                                      onClick={() => {
                                        const newVehicules = formData.tvs.vehicules.filter((_, i) => i !== idx);
                                        updateNestedField('tvs', 'vehicules', newVehicules);
                                      }}
                                    >
                                      🗑️
                                    </button>
                                  </div>
                                  
                                  <div style={{ marginTop: '8px', padding: '8px', background: '#f0f4ff', borderRadius: '6px', fontSize: '11px' }}>
                                    <strong>Calcul TVS 2025:</strong> Barème {calcul.bareme} | Tarif unitaire: {calcul.tarifUnitaire}€ | Trimestres: {calcul.trimestres} | 
                                    <strong style={{ color: '#1e40af', marginLeft: '8px' }}>Montant annuel: {calcul.montantAnnuel}€</strong>
                                  </div>
                                </div>
                              );
                            })}
                            
                            {formData.tvs.vehicules.length > 0 && (
                              <div style={{ padding: '12px', background: '#f7f8fb', fontWeight: 700, fontSize: '13px', textAlign: 'right' }}>
                                Total TVS 2025: {formData.tvs.vehicules.reduce((sum, v) => sum + calculateTVS2025(v).montantAnnuel, 0).toFixed(2)}€
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </>
                  )}
                </div>
              </div>
              
              <div className="modal-footer">
                <button type="button" onClick={onClose} className="btn">
                  Annuler
                </button>
                <button type="submit" className="btn primary">
                  Enregistrer
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }
    
    
    // ==================== RENDER APP ====================
    // Rendre la fonction globalement accessible
    window.initDashboardApp = function() {
      console.log('🚀 Initialisation du dashboard React...');
      try {
        ReactDOM.render(<App />, document.getElementById('root'));
        console.log('✅ Dashboard React initialisé avec succès');
      } catch (error) {
        console.error('❌ Erreur lors de l\'initialisation du dashboard:', error);
      }
    }
    
    // Note: Cette fonction sera appelée par showDashboard() après authentification Firebase
  </script>
</body>
</html>
